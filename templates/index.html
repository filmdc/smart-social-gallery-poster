<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Asset Gallery: {{ current_folder_info.display_name }}</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='galleryout/favicon.ico') }}">
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.4.3/dist/css/tom-select.css" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0a0a0a;
            --surface-color: #1a1a1a;
            --surface-hover: #252525;
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --text-color: #f8f9fa;
            --text-muted: #adb5bd;
            --border-color: #343a40;
            --danger-color: #dc3545;
            --danger-hover: #c82333;
            --favorite-color: #ffc107;
            --workflow-color: #28a745;
            --success-color: #20c997;
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.3);
            --sidebar-width: 320px;
            --gallery-column-size: 320px;
        }

        * {
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Inter", sans-serif;
            margin: 0;
            background: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            min-height: 100vh;
        }

        body.lightbox-open,
        body.modal-open {
            overflow: hidden;
        }

        #notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: flex-end;
        }

        .notification {
            background-color: var(--surface-color);
            color: var(--text-color);
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            border-left: 5px solid var(--primary-color);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            font-weight: 600;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.success {
            background-color: var(--success-color);
            color: white;
            border-color: #1a9c77;
        }

        .notification.error {
            background-color: var(--danger-color);
            color: white;
            border-color: #b32a38;
        }

        .notification.warning {
            background-color: var(--favorite-color);
            color: #000;
            border-color: #d39e00;
        }

        .notification.info {
            background-color: var(--primary-color);
            color: white;
            border-color: #0056b3;
        }

        .sidebar {
            width: var(--sidebar-width);
            min-width: var(--sidebar-width);
            background: var(--surface-color);
            border-right: 1px solid var(--border-color);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: sticky;
            top: 0;
            transition: min-width 0.3s cubic-bezier(0.4, 0, 0.2, 1), transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
        }

        body.sidebar-expanded .sidebar {
            min-width: 600px;
        }

        .main-content {
            flex-grow: 1;
            padding-bottom: 80px;
            transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-header {
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            flex-shrink: 0;
        }

        .sidebar-header h1 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        #sidebar-toggle-btn {
            display: none;
            background: var(--surface-hover);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            align-items: center;
            gap: 0.5rem;
        }

        .folder-controls {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: 1rem;
            flex-shrink: 0;
        }

        .folder-search-input {
            width: 100%;
            background: var(--glass-bg);
            color: var(--text-color);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
            font-size: 0.9rem;
        }

        .folder-sort-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .folder-sort-buttons button {
            flex-grow: 1;
            background: var(--surface-hover);
            color: var(--text-muted);
            border: 1px solid var(--glass-border);
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .folder-sort-buttons button.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .sidebar-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .sidebar-actions button {
            background: none;
            border: 1px solid var(--glass-border);
            color: var(--text-color);
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .folder-tree-container {
            flex-grow: 1;
            overflow-y: auto;
            min-height: 0;
        }

        .folder-tree,
        .folder-tree ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .folder-tree li {
            padding-left: 20px;
            position: relative;
        }

        .folder-tree>li:first-child {
            padding-left: 0;
        }

        .folder-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 8px;
            transition: background-color 0.2s;
            position: relative;
        }

        .folder-item:hover {
            background-color: var(--surface-hover);
        }

        .folder-item.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
        }

        .sp-folder-badge {
            background: #038387;
            color: white;
            font-size: 0.55rem;
            padding: 1px 4px;
            border-radius: 3px;
            font-weight: 700;
            margin-left: 5px;
            vertical-align: middle;
            letter-spacing: 0.02em;
        }
        .folder-item.active .sp-folder-badge {
            background: rgba(255,255,255,0.3);
        }

        .toggle-btn {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.1rem;
            line-height: 1;
            user-select: none;
        }

        .toggle-btn.empty {
            visibility: hidden;
        }

        .folder-link {
            flex-grow: 1;
            text-decoration: none;
            color: inherit;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-left: 25px;
            cursor: pointer;
        }

        .folder-actions {
            margin-left: auto;
            display: flex;
            opacity: 1;
        }

        .folder-action-btn {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .folder-action-btn:hover {
            background-color: rgba(255, 255, 255, 0.15);
        }

        .folder-tree li.collapsed>ul {
            display: none;
        }

        .folder-tree li.is-hidden {
            display: none;
        }

        .folder-tree li:not(.collapsed)>.folder-item>.toggle-btn::before {
            content: '▾';
        }

        .folder-tree li.collapsed>.folder-item>.toggle-btn::before {
            content: '▸';
        }

        .folder-tree li.no-children>.folder-item>.toggle-btn {
            visibility: hidden;
        }

        #create-folder-btn {
            width: 100%;
            background: var(--gradient-secondary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: var(--shadow-sm);
            margin-top: 1.5rem;
            flex-shrink: 0;
        }

        #create-folder-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        #smashcut-link-btn {
            display: block;
            width: 100%;
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: var(--shadow-sm);
            margin-top: 0.75rem;
            flex-shrink: 0;
            text-align: center;
            text-decoration: none;
        }

        #smashcut-link-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .breadcrumbs {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            padding: 1rem 2rem;
            background: var(--surface-color);
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
        }

        .breadcrumb-links {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
            overflow: hidden;
            flex-grow: 1;
        }

        .breadcrumb-links a,
        .breadcrumb-links span {
            color: var(--text-muted);
            text-decoration: none;
            font-weight: 500;
            white-space: nowrap;
        }

        .breadcrumb-links a:hover {
            color: var(--text-color);
        }

        .breadcrumb-links span:last-child {
            color: var(--text-color);
            font-weight: 700;
            text-overflow: ellipsis;
            overflow: hidden;
        }

        .gallery-sort-controls {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        .gallery-sort-controls .sort-btn {
            flex-shrink: 0;
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            background: var(--surface-hover);
            color: var(--text-color);
            font-weight: 600;
            text-decoration: none;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            transition: all 0.3s;
        }

        .gallery-sort-controls .sort-btn:hover {
            background: var(--surface-color);
        }

        .gallery-sort-controls .sort-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .file-count-badge {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            background: var(--surface-hover);
            color: var(--text-muted);
            font-weight: 600;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            white-space: nowrap;
        }

        .view-size-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.35rem 0.75rem;
            background: var(--surface-hover);
            border-radius: 8px;
            border: 1px solid var(--glass-border);
        }

        .view-size-control label {
            font-size: 0.85rem;
            color: var(--text-muted);
            white-space: nowrap;
        }

        .view-size-slider {
            width: 80px;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--border-color);
            border-radius: 2px;
            cursor: pointer;
        }

        .view-size-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .view-size-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .view-size-slider::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border: none;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
        }

        .filter-bar {
            padding: 1.5rem 2rem;
        }

        .filter-bar form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .filter-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-bar label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-muted);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-bar select,
        .filter-bar input[type="text"],
        .filter-bar button,
        .filter-bar a {
            background: var(--glass-bg);
            color: var(--text-color);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .filter-bar input[type="text"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .filter-bar button {
            background: var(--primary-color);
            cursor: pointer;
            font-weight: 600;
            color: white;
            border: 1px solid var(--primary-color);
        }

        .filter-bar button:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }

        .filter-bar button.refresh-btn {
            background: var(--workflow-color);
            border-color: var(--workflow-color);
        }

        .filter-bar a {
            text-decoration: none;
            text-align: center;
            color: var(--text-muted);
        }

        .filter-bar a:hover {
            background: var(--surface-hover);
            color: var(--text-color);
        }

        .filter-group-inline {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .filter-group-inline input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary-color);
        }

        .filter-actions-row {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .filter-actions-row>a,
        .filter-actions-row>button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .filter-actions-row button[type="submit"] {
            padding-left: 0.8rem;
            padding-right: 0.8rem;
        }

        .mobile-actions-row {
            display: flex;
            gap: 0.75rem;
        }

        .mobile-actions-row>* {
            flex-grow: 1;
            text-align: center;
            justify-content: center;
        }

        .mobile-actions-row button {
            padding-left: 0.8rem;
            padding-right: 0.8rem;
        }

        .ts-control {
            background: var(--glass-bg) !important;
            border: 1px solid var(--glass-border) !important;
            border-radius: 8px !important;
            backdrop-filter: blur(10px) !important;
        }

        .ts-dropdown,
        .ts-control,
        .ts-control input {
            color: var(--text-color) !important;
        }

        .ts-dropdown {
            background: var(--surface-color) !important;
            border: 1px solid var(--border-color) !important;
            z-index: 1000;
            border-radius: 8px !important;
            box-shadow: var(--shadow-lg) !important;
        }

        #gallery-anchor {
            display: block;
            position: relative;
            top: -20px;
            visibility: hidden;
        }

        .gallery-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(var(--gallery-column-size), 1fr));
            gap: 2rem;
            padding: 2rem;
            min-height: 50vh;
        }

        .gallery-item {
            background: var(--glass-bg);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            display: flex;
            flex-direction: column;
            position: relative;
            border: 2px solid transparent;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
        }

        .gallery-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .gallery-item.selected {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.2);
        }

        .gallery-item.focused {
            outline: 2px solid var(--text-color);
            outline-offset: 2px;
        }

        .selection-checkmark {
            position: absolute;
            bottom: 12px;
            right: 12px;
            width: 24px;
            height: 24px;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid var(--text-color);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 11;
            transition: all 0.3s;
            color: transparent;
            cursor: pointer;
            font-size: 12px;
            backdrop-filter: blur(10px);
        }

        .gallery-item.selected .selection-checkmark {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            transform: scale(1.1);
        }

        .thumbnail-link {
            cursor: pointer;
        }

        .thumbnail-wrapper {
            position: relative;
            width: 100%;
            background: var(--surface-color);
            overflow: hidden;
        }

        .thumbnail-wrapper img,
        .thumbnail-wrapper video {
            display: block;
            width: 100%;
            height: auto;
            transition: transform 0.3s;
        }

        .gallery-item:hover .thumbnail-wrapper img,
        .gallery-item:hover .thumbnail-wrapper video {
            transform: scale(1.05);
        }

        .item-info {
            padding: 1.5rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding-bottom: 48px;
        }

        .item-info p {
            margin: 0;
            word-wrap: break-word;
            font-size: 0.95rem;
            font-weight: 500;
            line-height: 1.4;
            margin-bottom: 0.75rem;
        }

        .file-metadata {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.25rem 0.75rem;
        }

        .file-metadata span {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        .item-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: auto;
            flex-wrap: wrap;
        }

        .item-actions a,
        .item-actions button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            background: var(--glass-bg);
            color: var(--text-color);
            padding: 0.6rem 1rem;
            border-radius: 8px;
            font-size: 0.8rem;
            border: 1px solid var(--glass-border);
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            backdrop-filter: blur(10px);
        }

        .item-actions .delete-btn {
            background: var(--danger-color);
            border-color: var(--danger-color);
            color: white;
        }

        .favorite-btn.favorited {
            background: var(--favorite-color);
            color: #000;
            border-color: var(--favorite-color);
        }

        .social-post-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            border-color: #764ba2 !important;
            color: white !important;
        }

        .social-post-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .duration-overlay {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            backdrop-filter: blur(10px);
            z-index: 10;
        }

        .workflow-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background: var(--workflow-color);
            color: white;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            text-decoration: none;
            font-weight: 600;
        }

        #selection-bar {
            position: fixed;
            bottom: 0;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            left: 320px;
            right: 0;
            background: var(--glass-bg);
            border-top: 1px solid var(--glass-border);
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            z-index: 1001;
            box-sizing: border-box;
            backdrop-filter: blur(20px);
            flex-wrap: wrap;
        }

        body.sidebar-expanded #selection-bar {
            left: 600px;
        }

        #selection-bar.visible {
            transform: translateY(0);
        }

        #selection-bar button {
            padding: 0.75rem 1.5rem;
            font-size: 0.9rem;
            border-radius: 8px;
            border: none;
            background: var(--primary-color);
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        #selection-bar .delete-btn {
            background: var(--danger-color);
        }

        #selection-counter {
            font-weight: 700;
            margin-right: auto;
            padding-left: 1rem;
            color: var(--primary-color);
        }

        #platform-warnings {
            display: none;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-right: 1rem;
        }

        #platform-warnings.visible {
            display: flex;
        }

        .platform-warning {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid var(--warning-color);
            color: var(--warning-color);
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        #drag-drop-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1002;
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
            backdrop-filter: blur(5px);
        }

        #drag-drop-overlay.visible {
            display: block;
            opacity: 1;
        }

        #drop-zone-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            z-index: 1003;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            display: none;
            flex-direction: column;
            max-height: 80vh;
        }

        #drop-zone-panel.visible {
            display: flex;
        }

        #drop-zone-panel h3 {
            margin: 0;
            padding: 1rem 1.5rem;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            flex-shrink: 0;
        }

        #drop-zone-folders {
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            padding: 0;
            min-height: 0;
            flex-grow: 1;
        }

        #cancel-drop-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 1rem;
            cursor: pointer;
            border-bottom-left-radius: 16px;
            border-bottom-right-radius: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
            flex-shrink: 0;
        }

        #loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-color);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.4s;
        }

        .loader {
            border: 4px solid var(--surface-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 1.2s linear infinite;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        #lightbox-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #lightbox-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 1.8rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
            z-index: 2001;
        }

        #lightbox-prev {
            left: 30px;
        }

        #lightbox-next {
            right: 30px;
        }

        #lightbox-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 2002;
            padding: 1rem;
            background: linear-gradient(180deg, rgba(0, 0, 0, 0.8) 0%, rgba(0, 0, 0, 0.4) 70%, transparent 100%);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: center;
            text-align: center;
        }

        #lightbox-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            word-break: break-word;
            hyphens: auto;
            max-width: 90vw;
        }

        #lightbox-toolbar {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        #lightbox-toolbar button,
        #lightbox-toolbar a {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.75rem;
            border-radius: 10px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 44px;
            height: 44px;
            backdrop-filter: blur(10px);
        }

        #lightbox-toolbar button:hover,
        #lightbox-toolbar a:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Playback Speed Control */
        #speed-control {
            display: none;
            align-items: center;
            gap: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 0.4rem 0.75rem;
            backdrop-filter: blur(10px);
        }

        #speed-control.visible {
            display: flex;
        }

        #speed-control label {
            color: white;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        #speed-slider {
            width: 80px;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            outline: none;
            cursor: pointer;
        }

        #speed-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.1s;
        }

        #speed-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        #speed-slider::-moz-range-thumb {
            width: 14px;
            height: 14px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        #speed-value {
            color: white;
            font-size: 0.8rem;
            min-width: 35px;
            text-align: center;
            font-weight: bold;
        }

        #speed-reset {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 0.7rem;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            cursor: pointer;
        }

        #speed-reset:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        #lightbox-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            padding: 6rem 1rem 2rem;
        }

        #lightbox-media {
            display: flex;
            align-items: center;
            justify-content: center;
            max-width: 95vw;
            max-height: 90vh;
        }

        #lightbox-media img,
        #lightbox-media video {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            cursor: grab;
        }

        #backToTopBtn {
            display: none;
            position: fixed;
            bottom: 110px;
            right: 30px;
            z-index: 99;
            font-size: 1.2rem;
            border: none;
            background: var(--primary-color);
            color: white;
            cursor: pointer;
            padding: 12px 16px;
            border-radius: 50%;
            transition: all 0.3s;
            box-shadow: var(--shadow-md);
        }

        #load-more-container {
            text-align: center;
            padding: 3rem;
        }

        #load-more-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 1rem 2.5rem;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: var(--shadow-sm);
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
        }

        #node-summary-overlay,
        #upload-overlay,
        #sync-overlay,
        #tags-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #node-summary-overlay {
            z-index: 2100;
        }

        #tags-overlay {
            z-index: 2150;
        }

        #upload-overlay {
            z-index: 2200;
        }

        #sync-overlay {
            z-index: 2300;
            display: none;
            opacity: 1;
            pointer-events: all;
        }

        #node-summary-overlay.visible,
        #upload-overlay.visible,
        #tags-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .node-summary-panel,
        #upload-panel,
        #sync-panel,
        #tags-panel {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            width: 90vw;
            display: flex;
            flex-direction: column;
            transform: scale(0.95);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .node-summary-panel {
            max-width: 900px;
            max-height: 85vh;
        }

        #upload-panel {
            max-width: 600px;
            max-height: 85vh;
        }

        #tags-panel {
            max-width: 500px;
            max-height: 80vh;
        }

        #sync-panel {
            max-width: 500px;
            padding: 2rem;
            align-items: center;
            text-align: center;
        }

        #node-summary-overlay.visible .node-summary-panel,
        #upload-overlay.visible #upload-panel,
        #tags-overlay.visible #tags-panel {
            transform: scale(1);
        }

        /* Tags Panel Styles */
        .tags-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .tags-header h2 {
            margin: 0;
            font-size: 1.25rem;
        }

        .tags-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }

        .tags-section {
            margin-bottom: 1.5rem;
        }

        .tags-section:last-child {
            margin-bottom: 0;
        }

        .tags-section h3 {
            margin: 0 0 0.25rem 0;
            font-size: 1rem;
            color: var(--text-primary);
        }

        .tags-help {
            margin: 0 0 0.75rem 0;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .tags-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .tag-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tag-item:hover {
            border-color: var(--accent-color);
        }

        .tag-item.selected {
            background: var(--accent-color);
            border-color: var(--accent-color);
            color: white;
        }

        .tag-item input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
        }

        .tag-item label {
            margin: 0;
            cursor: pointer;
            user-select: none;
        }

        .tags-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        .tags-footer button {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--surface-color);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .tags-footer button:hover {
            background: var(--bg-color);
        }

        .tags-footer button.primary-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #764ba2;
            color: white;
        }

        .tags-footer button.primary-btn:hover {
            opacity: 0.9;
        }

        .tags-empty {
            color: var(--text-muted);
            font-style: italic;
            padding: 0.5rem;
        }

        .node-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            background: var(--surface-color);
        }

        .node-summary-header h2 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .node-summary-header .close-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.8rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        #node-summary-content {
            padding: 1.5rem;
            overflow-y: auto;
        }

        .summary-node-item {
            margin-bottom: 1.5rem;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .summary-node-header {
            color: white;
            padding: 0.75rem 1rem;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .summary-node-header small {
            opacity: 0.8;
            font-weight: normal;
            margin-left: 0.5rem;
        }

        .summary-node-params {
            list-style: none;
            margin: 0;
            padding: 1rem;
            background: var(--glass-bg);
        }

        .summary-node-params li {
            padding: 0.5rem 0;
            font-size: 1rem;
            border-bottom: 1px solid var(--glass-border);
        }

        .summary-node-params li:last-child {
            border-bottom: none;
        }

        .summary-node-params strong {
            color: var(--text-color);
            margin-right: 0.5rem;
        }

        .summary-node-params code {
            color: var(--text-muted);
            word-break: break-all;
            white-space: pre-wrap;
            background: rgba(0, 0, 0, 0.2);
            padding: 2px 5px;
            border-radius: 4px;
        }

        /* Workflow Comparison Styles */
        #compare-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 2500;
            display: none;
            justify-content: center;
            align-items: center;
        }

        #compare-overlay.visible {
            display: flex;
        }

        .compare-panel {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            width: 95vw;
            max-width: 1400px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .compare-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--surface-color);
        }

        .compare-header h2 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .compare-columns {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            overflow-x: auto;
            overflow-y: hidden;
            flex: 1;
        }

        .compare-column {
            flex: 1;
            min-width: 320px;
            max-width: 450px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            background: var(--glass-bg);
        }

        .compare-column-header {
            position: sticky;
            top: 0;
            background: var(--primary-color);
            color: white;
            padding: 0.75rem 1rem;
            font-weight: bold;
            font-size: 0.85rem;
            border-radius: 8px 8px 0 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .compare-column-header.no-workflow {
            background: var(--danger-color);
        }

        .compare-column-content {
            overflow-y: auto;
            flex: 1;
            max-height: calc(90vh - 150px);
            padding: 0.5rem;
        }

        .compare-node-item {
            margin-bottom: 0.75rem;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .compare-node-header {
            color: white;
            padding: 0.5rem 0.75rem;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .compare-node-params {
            list-style: none;
            margin: 0;
            padding: 0.5rem 0.75rem;
            background: var(--glass-bg);
            font-size: 0.8rem;
        }

        .compare-node-params li {
            padding: 0.3rem 0;
            border-bottom: 1px solid var(--glass-border);
        }

        .compare-node-params li:last-child {
            border-bottom: none;
        }

        .param-different {
            background: rgba(255, 200, 0, 0.15);
            border-left: 3px solid #ffc800;
            padding-left: 0.5rem;
            margin-left: -0.75rem;
            padding-right: 0.75rem;
        }

        .param-unique {
            background: rgba(0, 200, 100, 0.15);
            border-left: 3px solid #00c864;
            padding-left: 0.5rem;
            margin-left: -0.75rem;
            padding-right: 0.75rem;
        }

        .node-missing {
            opacity: 0.4;
            background: rgba(255, 100, 100, 0.1);
        }

        .node-missing .compare-node-header {
            background: #666 !important;
        }

        #refresh-btn {
            margin-left: auto;
        }

        .upload-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
        }

        .upload-header h2 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .upload-header p {
            margin: 0.5rem 0 0;
            color: var(--text-muted);
        }

        .upload-body {
            padding: 1.5rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        #drop-zone {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            color: var(--text-muted);
            transition: all 0.3s;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            flex-grow: 1;
        }

        #drop-zone.dragover {
            border-color: var(--primary-color);
            background: var(--surface-hover);
            transform: scale(1.02);
        }

        #drop-zone p {
            font-size: 1.1rem;
            font-weight: 500;
            margin: 0 0 1rem 0;
        }

        #file-upload-btn {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
        }

        #file-list {
            list-style: none;
            padding: 0;
            margin-top: 1.5rem;
            max-height: 200px;
            overflow-y: auto;
        }

        #file-list li {
            background: var(--glass-bg);
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-size {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .upload-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .upload-footer button {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
        }

        #upload-cancel-btn {
            background: var(--surface-hover);
            color: var(--text-color);
        }

        #upload-submit-btn {
            background: var(--success-color);
            color: white;
        }

        #upload-progress-container {
            display: none;
            margin-top: 1rem;
        }

        #upload-progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
        }

        #upload-progress-fill {
            width: 0%;
            height: 100%;
            background: var(--primary-color);
            transition: width 0.2s;
        }

        #upload-file-input {
            display: none;
        }

        #sync-message {
            margin: 0 0 1rem;
            font-size: 1.1rem;
            font-weight: 500;
        }

        #sync-progress-bar {
            width: 100%;
            height: 10px;
            background-color: var(--border-color);
            border-radius: 5px;
            overflow: hidden;
        }

        #sync-progress-fill {
            width: 0%;
            height: 100%;
            background-color: var(--primary-color);
            transition: width 0.3s ease;
        }

        #mobile-filter-toggle {
            display: none;
            width: 100%;
            background: var(--surface-hover);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            text-align: left;
        }

        .mobile-actions-only {
            display: none;
        }

        @media (max-width: 1024px) {
            body.sidebar-expanded-mobile .sidebar {
                position: fixed;
                width: 100%;
                min-width: 100%;
                height: 100%;
                top: 0;
                left: 0;
                transform: translateX(0);
                z-index: 1005;
            }

            body.sidebar-expanded-mobile .main-content {
                display: none;
            }

            body:not(.sidebar-expanded-mobile) {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                position: static;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }

            #selection-bar {
                left: 0;
            }

            body.sidebar-expanded #selection-bar {
                left: 0;
            }

            #sidebar-toggle-btn {
                display: flex;
            }

            #sidebar-expand-btn {
                display: none;
            }

            .sidebar.nav-collapsed .folder-controls,
            .sidebar.nav-collapsed .folder-tree-container,
            .sidebar.nav-collapsed #create-folder-btn,
            .sidebar.nav-collapsed #smashcut-link-btn {
                display: none;
            }
        }

@media (max-width: 768px) {
            .breadcrumbs {
                flex-direction: column;
                align-items: stretch;
                padding: 0.5rem 1rem; 
            }

            .gallery-sort-controls {
                justify-content: space-between; 
                width: 100%;
                gap: 0.3rem; 
                flex-wrap: wrap; 
            }

            .gallery-sort-controls .sort-btn,
            .gallery-sort-controls .file-count-badge {
                padding: 0.4rem 0.5rem !important;
                font-size: 0.75rem !important;
                flex-grow: 1;
                text-align: center;
                justify-content: center;
                white-space: nowrap;
            }

            .view-size-control {
                padding: 0.3rem 0.5rem;
                flex-grow: 1;
                justify-content: center;
            }

            .view-size-control label {
                font-size: 0.75rem;
            }

            .view-size-slider {
                width: 60px;
            }

            .filter-bar form {
                grid-template-columns: 1fr;
            }

            #mobile-filter-toggle {
                display: block;
                margin-bottom: 1rem;
            }

            .filter-form-grid {
                display: none;
            }

            .filter-form-grid.visible {
                display: grid;
                grid-template-columns: 1fr;
            }

            .desktop-actions-only {
                display: none;
            }

            .mobile-actions-only {
                display: flex;
                flex-direction: column;
                gap: 0.75rem;
            }

            .gallery-container {
                grid-template-columns: 1fr;
                padding: 1rem;
            }

            #selection-bar {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
                padding: 1rem;
            }

            #selection-bar .actions-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
                width: 100%;
            }

            #selection-bar>#select-all-btn,
            #selection-bar>#deselect-all-btn {
                grid-column: span 2;
            }

            #selection-counter {
                text-align: center;
                padding-left: 0;
                margin-bottom: 0.5rem;
            }

            #drop-zone-panel {
                width: 90vw;
            }

            .lightbox-nav {
                width: 50px;
                height: 50px;
            }

            #lightbox-prev {
                left: 10px;
            }

            #lightbox-next {
                right: 10px;
            }

            .node-summary-panel {
                width: 95vw;
                max-height: 90vh;
            }

            .summary-node-params li {
                font-size: 0.9rem;
            }
        }

        /* --- CSS RULE: Widen move panel on desktop screens --- */
        @media (min-width: 1025px) {
            #drop-zone-panel {
                width: 650px;
                max-width: 90vw;
                /* Adds a limit for very large screens */
            }
        }

        /* Shortcuts Help Popup */
        #shortcuts-help-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 3000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        #shortcuts-help-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .shortcuts-panel {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            width: 800px;           
            max-width: 95vw;
            max-height: 85vh;       
            display: flex;          
            flex-direction: column; 
            overflow: hidden;
        }

        .shortcuts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--surface-hover);
            flex-shrink: 0; 
        }
        
        .shortcuts-header .close-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 2rem;
            line-height: 1;
            cursor: pointer;
            padding: 0 0.5rem;
            transition: color 0.2s;
        }
        .shortcuts-header .close-btn:hover {
            color: var(--danger-color);
        }

        .shortcuts-content {
            padding: 1.5rem;
            display: grid;
            gap: 0.5rem 2rem;       
            grid-template-columns: 1fr 1fr; 
            overflow-y: auto;      
            align-content: start;
        }

        
        @media (max-width: 768px) {
            .shortcuts-panel {
                width: 95vw;
            }
            .shortcuts-content {
                grid-template-columns: 1fr;
            }
        }

        .shortcut-item {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .shortcut-item .key {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            padding: 4px 8px;
            border-radius: 6px;
            font-family: monospace;
            font-weight: bold;
            min-width: 24px;
            text-align: center;
            box-shadow: 0 2px 0 var(--border-color);
            font-size: 0.9rem;
        }

        .shortcut-item .desc {
            color: var(--text-muted);
            font-size: 0.95rem;
        }
        
        /* --- LIGHTBOX SHORTCUTS BAR --- */
        #lightbox-shortcuts {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px; /* Ridotto per far stare tutto */
            align-items: center;
            background: rgba(0, 0, 0, 0.75); /* Leggermente più scuro per contrasto */
            backdrop-filter: blur(12px);
            padding: 8px 20px;
            border-radius: 50px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            z-index: 2005;
            pointer-events: none;
            white-space: nowrap;
            box-shadow: 0 4px 15px rgba(0,0,0,0.6);
        }

        .kb-group {
            display: flex;
            align-items: center;
            gap: 5px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.75rem; /* Testo leggermente più piccolo */
            font-weight: 500;
        }

        /* Classe speciale per evidenziare Quick Delete */
        .kb-danger {
            color: #ff6b6b; /* Rosso chiaro */
            font-weight: 700;
        }

        .kb-key {
            background: linear-gradient(180deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.1) 100%);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            padding: 1px 5px;
            min-width: 18px;
            text-align: center;
            font-family: monospace;
            font-weight: 700;
            color: #fff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            box-shadow: 0 2px 0 rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.2);
            font-size: 0.75rem;
        }

        .kb-separator {
            width: 1px;
            height: 12px;
            background: rgba(255, 255, 255, 0.2);
            margin: 0 2px;
        }

        @media (max-width: 1024px) {
            #lightbox-shortcuts { display: none !important; }
        }
        
        /* --- LIGHTBOX LOADER --- */
        .lightbox-loader {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-bottom-color: var(--primary-color); /* Usa il colore blu del tema */
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
            position: absolute;
            top: 50%;
            left: 50%;
            /* Centramento perfetto considerando la trasformazione */
            margin-top: -25px; 
            margin-left: -25px;
            z-index: 15; /* Sopra l'immagine mentre carica */
        }

        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }        

        /* --- INPUT MEDIA IN NODE SUMMARY --- */
        .input-media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .input-media-card {
            background: var(--surface-hover);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .input-media-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-color);
            font-size: 0.95rem;
            word-break: break-all;
            text-align: center;
        }

        .input-media-preview {
            width: 100%;
            height: 300px; 
            object-fit: contain;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        /* Audio player styling specific */
        audio.input-media-preview {
            height: 50px;
            margin-top: auto;
            margin-bottom: auto;
        }

        .input-media-actions {
            display: flex;
            gap: 0.5rem;
            width: 100%;
            margin-top: auto;
        }

        .input-media-btn {
            flex: 1;
            padding: 0.6rem;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            background: var(--primary-color);
            color: white;
            text-decoration: none;
            text-align: center;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .input-media-btn:hover {
            background: var(--primary-hover);
            text-decoration: none;
        }

        .input-media-btn.secondary {
            background: var(--surface-color);
            border-color: var(--border-color);
        }
        .input-media-btn.secondary:hover {
            background: rgba(255,255,255,0.1);
        }

        @media (max-width: 768px) {
            .input-media-grid {
                grid-template-columns: 1fr;
            }
            .input-media-preview {
                height: 200px; /* Più piccolo su mobile */
            }
        }

        </style>
</head>

<body>
    <div id="notification-container"></div>
    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="{{ url_for('gallery_view', folder_key='_root_') }}" style="text-decoration: none;">
                <h1>Smart Asset Gallery</h1>
            </a>
            <div class="sidebar-actions">
                <button id="sidebar-expand-btn" title="Expand Sidebar">
                    <span>↔️</span><span id="sidebar-expand-text">Expand</span>
                </button>
                <button id="sidebar-toggle-btn">
                    <span>☰</span><span id="sidebar-toggle-text">Show Folders</span>
                </button>
            </div>
        </div>
        <div class="folder-controls">
            <input type="search" class="folder-search-input" id="folder-search-nav" placeholder="🔍 Search folders...">
            <div class="folder-sort-buttons" id="folder-sort-nav">
                <button data-sort="name" class="active" title="Sort by name">A-Z</button>
                <button data-sort="mtime" title="Sort by date">🗓️</button>
            </div>
        </div>
        <div class="folder-tree-container">
            <ul class="folder-tree" id="folder-tree-nav"></ul>
        </div>
        <button id="create-folder-btn">➕ Create New Folder</button>
        <a href="/galleryout/smashcut" id="smashcut-link-btn">Smash Cut Generator</a>
        {% if social_enabled is defined and social_enabled %}
        <a href="/galleryout/social/dashboard" id="social-link-btn" style="display:block;text-align:center;padding:0.6rem 1rem;margin:0.3rem 1rem;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border-radius:8px;text-decoration:none;font-size:0.85rem;font-weight:600;transition:opacity 0.2s;">Social Posts</a>
        {% endif %}
        {% if social_enabled is defined and social_enabled %}
        <div style="text-align:center;padding:0.4rem 1rem;font-size:0.8rem;">
            {% if current_user is defined and current_user.is_authenticated %}
            <span style="color:var(--text-muted);">{{ current_user.display_name }}</span>
            &nbsp;|&nbsp;
            <a href="/galleryout/social/logout" style="color:var(--text-muted);text-decoration:none;">Logout</a>
            {% else %}
            <a href="/galleryout/social/login" style="color:var(--text-muted);text-decoration:none;">Login</a>
            {% endif %}
        </div>
        {% endif %}
    </aside>
    <div class="main-content">
        <header class="breadcrumbs">
            <div class="breadcrumb-links">
                {% for crumb in breadcrumbs %}
                <a href="{{ url_for('gallery_view', folder_key=crumb.key) }}">{{ crumb.display_name }}</a>
                {% if not loop.last %}<span>/</span>{% endif %}
                {% endfor %}
            </div>
            <div class="gallery-sort-controls">
                <span class="file-count-badge">
                    📂 {{ total_files }} Files {% if total_files != total_folder_files %}({{ total_folder_files }} Total){% endif %}
                </span>
                {% set current_sort_by = request.args.get('sort_by', 'date') %}
                {% set current_sort_order = request.args.get('sort_order', 'desc') %}
                {% set date_is_active = current_sort_by == 'date' %}
                {% set date_next_order = 'asc' if date_is_active and current_sort_order == 'desc' else 'desc' %}
                {% set date_query_params = dict(request.args.to_dict(flat=False), sort_by='date',
                sort_order=date_next_order) %}
                <a href="{{ url_for('gallery_view', folder_key=current_folder_key, **date_query_params) }}"
                    class="sort-btn {{ 'active' if date_is_active else '' }}">
                    Sort by Date {% if date_is_active %}{{ '↑' if current_sort_order == 'asc' else '↓' }}{% endif %}
                </a>
                {% set name_is_active = current_sort_by == 'name' %}
                {% set name_next_order = 'desc' if name_is_active and current_sort_order == 'asc' else 'asc' %}
                {% set name_query_params = dict(request.args.to_dict(flat=False), sort_by='name',
                sort_order=name_next_order) %}
                <a href="{{ url_for('gallery_view', folder_key=current_folder_key, **name_query_params) }}"
                    class="sort-btn {{ 'active' if name_is_active else '' }}">
                    Sort by Name {% if name_is_active %}{{ '↑' if current_sort_order == 'asc' else '↓' }}{% endif %}
                </a>
                <div class="view-size-control">
                    <label for="view-size-slider" title="Adjust thumbnail size">Size:</label>
                    <input type="range" id="view-size-slider" class="view-size-slider" min="150" max="600" value="320" step="25">
                </div>
            </div>
        </header>
        <div class="filter-bar">
            <form method="GET" action="{{ url_for('gallery_view', folder_key=current_folder_key) }}">
                <input type="hidden" name="sort_by" value="{{ request.args.get('sort_by', 'date') }}">
                <input type="hidden" name="sort_order" value="{{ request.args.get('sort_order', 'desc') }}">
                <button type="button" id="mobile-filter-toggle">⚙️ Filters & Options</button>
                <div class="filter-form-grid" id="filter-form-grid">
                    <div class="filter-group"><label for="search-input">🔍 Search by Name</label><input type="text"
                            name="search" id="search-input" placeholder="Search files..."
                            value="{{ request.args.get('search', '') }}"></div>
                    <div class="filter-group"><label for="extension-select">📄 Extensions</label><select
                            name="extension" id="extension-select" multiple>{% for ext in available_extensions %}<option
                                value="{{ ext }}" {% if ext in selected_extensions %}selected{% endif %}>{{ ext }}
                            </option>{% endfor %}</select></div>
                    <div class="filter-group"><label for="prefix-select">🏷️ Prefixes</label><select name="prefix"
                            id="prefix-select" multiple>{% for pfx in available_prefixes %}{% if pfx != '.gallery ' %}
                            <option value="{{ pfx }}" {% if pfx in selected_prefixes %}selected{% endif %}>{{ pfx }}
                            </option>{% endif %}{% endfor %}
                        </select></div>
                    <div class="filter-group">
                        <div class="filter-group-inline"><input type="checkbox" name="favorites" id="favorites-check"
                                value="true" {% if show_favorites %}checked{% endif %}><label for="favorites-check">⭐
                                Favorites Only</label></div>
                    </div>
                    <div class="filter-group mobile-actions-only"><label>Actions</label>
                        <div class="mobile-actions-row"><button type="submit">🔍 Filter</button><a
                                href="{{ url_for('gallery_view', folder_key=current_folder_key) }}">🔄 Reset</a></div>
                    </div>
                </div>
                <div class="filter-actions-row">
                    <div class="filter-actions-row desktop-actions-only"><button type="submit">🔍 Filter</button><a
                            href="{{ url_for('gallery_view', folder_key=current_folder_key) }}">🔄 Reset</a></div>
                    <button type="button" id="main-select-all-btn">✅ Select All</button><button type="button"
                        id="show-upload-modal-btn">☁️ Upload</button><button type="button" id="rescan-folder-btn"
                        style="background:var(--workflow-color);border-color:var(--workflow-color);">♻️
                        Rescan</button><button type="button" id="refresh-btn" class="refresh-btn">♻️ Refresh</button>
                </div>
            </form>
        </div>
        <div id="gallery-anchor"></div>
        <main class="gallery-container" id="gallery-container"></main>
        <div id="load-more-container"><button id="load-more-btn">📂 Load More</button></div>
    </div>
    <button onclick="scrollToTop()" id="backToTopBtn" title="Go to Top" style="display: none;"><svg width="20"
            height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
            stroke-linejoin="round">
            <polyline points="18 15 12 9 6 15"></polyline>
        </svg></button>
    <div id="drag-drop-overlay"></div>
    <div id="drop-zone-panel">
        <h3>📁 Move to Folder:</h3>
        <div class="folder-controls" style="padding: 0 1rem; margin-top: 1rem;">
            <input type="search" class="folder-search-input" id="folder-search-move" placeholder="🔍 Search folders...">
            <div class="folder-sort-buttons" id="folder-sort-move"><button data-sort="name"
                    class="active">A-Z</button><button data-sort="mtime">🗓️</button></div>
        </div>
        <div id="drop-zone-folders">
            <div class="folder-tree-container" style="padding: 1rem;">
                <ul class="folder-tree" id="move-folder-tree"></ul>
            </div>
        </div>
        <button id="cancel-drop-btn">❌ Cancel</button>
    </div>
    <div id="selection-bar">
        <span id="selection-counter">0 files selected</span>
        <div id="platform-warnings"></div>
        <div class="actions-grid"><button id="move-selected-btn">📁 Move</button><button id="favorite-selected-btn">⭐
                Add</button><button id="unfavorite-selected-btn">☆ Remove</button><button id="download-zip-btn">📦
                Zip</button><button id="compare-btn" style="display:none;">🔍 Compare</button>{% if social_enabled is defined and social_enabled and current_user is defined and current_user.is_authenticated %}<button id="social-post-btn" onclick="postSelectedToSocial()" style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-color:#764ba2;">📤 Post</button>{% endif %}<button id="delete-selected-btn" class="delete-btn">🗑️ Delete</button><button
                id="range-select-btn" style="display:none;">↔️ Range</button><button id="select-all-btn">✅
                All</button><button id="deselect-all-btn">❌ None</button></div>
    </div>
    <div id="compare-overlay">
        <div class="compare-panel">
            <div class="compare-header">
                <h2>🔍 Workflow Comparison</h2>
                <button class="close-btn" onclick="closeCompare()">&times;</button>
            </div>
            <div id="compare-content" class="compare-columns"></div>
        </div>
    </div>
    <div id="lightbox-overlay">
        <div id="lightbox-header">
            <div id="lightbox-title"></div>
            <!-- MODIFICATION START: Added rename button to the lightbox toolbar -->
            <div id="lightbox-toolbar">
                <button id="lightbox-zoom-out" title="Zoom Out">-</button>
                <button id="lightbox-zoom-in" title="Zoom In">+</button>
                <!-- Playback Speed Control (visible only for videos) -->
                <div id="speed-control" title="Playback Speed">
                    <label>🎬</label>
                    <input type="range" id="speed-slider" min="0.25" max="4" step="0.25" value="1">
                    <span id="speed-value">1x</span>
                    <button id="speed-reset" title="Reset to 1x">↺</button>
                </div>
                <a id="lightbox-download" href="#" title="Download File">💾</a>
                <button id="lightbox-rename-btn" title="Rename File">✏️</button>
                {% if social_enabled is defined and social_enabled and current_user is defined and current_user.is_authenticated %}
                <button id="lightbox-tags-btn" title="Programs & Campaigns">🏷️</button>
                <button id="lightbox-social-btn" title="Post to Social" style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);">📤</button>
                {% endif %}
                <button id="lightbox-delete-btn" title="Delete File">🗑️</button>
                <a id="lightbox-new-tab" href="#" target="_blank" title="Open in New Tab">↗️</a>
                <button class="close-btn" onclick="closeLightbox()" title="Close">×</button>
            </div>
            <!-- MODIFICATION END -->
        </div>
        <div id="lightbox-content">
            <div id="lightbox-media"></div>
        </div>
        <button id="lightbox-prev" class="lightbox-nav">‹</button><button id="lightbox-next"
            class="lightbox-nav">›</button>

        <!-- Keyboard Shortcuts Bar (Desktop Only) -->
        <div id="lightbox-shortcuts">
            <!-- Nav -->
            <div class="kb-group">
                <span class="kb-key">←</span>
                <span class="kb-key">→</span>
                <span>Nav</span>
            </div>
            <div class="kb-separator"></div>

            <!-- Zoom -->
            <div class="kb-group">
                <span class="kb-key">+</span>
                <span class="kb-key">-</span>
                <span>Zoom</span>
            </div>
            <div class="kb-separator"></div>

            <!-- Tags -->
            <div class="kb-group">
                <span class="kb-key">T</span>
                <span>Tags</span>
            </div>
            <div class="kb-separator"></div>

            <!-- Post to Social -->
            <div class="kb-group">
                <span class="kb-key">P</span>
                <span>Post</span>
            </div>
            <div class="kb-separator"></div>

            <!-- Open New Tab -->
            <div class="kb-group">
                <span class="kb-key">O</span>
                <span>New Tab</span>
            </div>
            <div class="kb-separator"></div>

            <!-- Rename -->
            <div class="kb-group">
                <span class="kb-key">R</span>
                <span>Rename</span>
            </div>
            <div class="kb-separator"></div>

            <!-- Quick Delete -->
            <div class="kb-group">
                <span class="kb-key">D</span>
                <span class="kb-key">Del</span>
                <span class="kb-danger">Quick Delete</span>
            </div>
            <div class="kb-separator"></div>

            <!-- Esc -->
            <div class="kb-group">
                <span class="kb-key">Esc</span>
                <span>Close</span>
            </div>
        </div>
        
    </div>
    <div id="node-summary-overlay">
        <div class="node-summary-panel">
            <div class="node-summary-header">
                <h2>📝 Node Summary</h2><button class="close-btn" id="close-summary-btn">×</button>
            </div>
            <div id="node-summary-content"></div>
        </div>
    </div>
    {% if social_enabled is defined and social_enabled and current_user is defined and current_user.is_authenticated %}
    <div id="tags-overlay">
        <div id="tags-panel">
            <div class="tags-header">
                <h2>🏷️ Programs & Campaigns</h2>
                <button class="close-btn" id="close-tags-btn">×</button>
            </div>
            <div class="tags-body">
                <input type="hidden" id="tags-file-id" value="">
                <div class="tags-section">
                    <h3>Programs</h3>
                    <p class="tags-help">Assign this asset to organizational programs</p>
                    <div id="programs-list" class="tags-list">
                        <div class="loading-spinner">Loading...</div>
                    </div>
                </div>
                <div class="tags-section">
                    <h3>Campaigns</h3>
                    <p class="tags-help">Assign this asset to marketing campaigns</p>
                    <div id="campaigns-list" class="tags-list">
                        <div class="loading-spinner">Loading...</div>
                    </div>
                </div>
            </div>
            <div class="tags-footer">
                <button type="button" id="tags-cancel-btn">Cancel</button>
                <button type="button" id="tags-save-btn" class="primary-btn">Save Tags</button>
            </div>
        </div>
    </div>
    {% endif %}
    <div id="upload-overlay">
        <div id="upload-panel">
            <div class="upload-header">
                <h2>Upload Files</h2>
                <p id="upload-destination-text">Upload to: <strong></strong></p>
            </div>
            <div class="upload-body">
                <input type="file" id="upload-file-input" multiple>
                <input type="file" id="upload-folder-input" webkitdirectory directory multiple style="display:none;">
                <div id="drop-zone">
                    <p>Drag & Drop files, folders, or ZIP files here</p>
                    <div style="display:flex;gap:0.5rem;justify-content:center;flex-wrap:wrap;">
                        <button type="button" id="file-upload-btn">📄 Select Files</button>
                        <button type="button" id="folder-upload-btn">📁 Select Folder</button>
                    </div>
                    <p style="font-size:0.8rem;color:var(--text-muted);margin-top:0.5rem;">ZIP files will be extracted automatically</p>
                </div>
                <ul id="file-list"></ul>
                <div id="upload-progress-container">
                    <div id="upload-progress-bar">
                        <div id="upload-progress-fill"></div>
                    </div>
                </div>
            </div>
            <div class="upload-footer"><button type="button" id="upload-cancel-btn">Cancel</button><button type="button"
                    id="upload-submit-btn">Upload</button></div>
        </div>
    </div>
    <div id="sync-overlay">
        <div id="sync-panel">
            <h3 id="sync-message">Scanning...</h3>
            <div id="sync-progress-bar">
                <div id="sync-progress-fill"></div>
            </div>
        </div>
    </div>
    <div id="rescan-modal-overlay"
        style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.8);backdrop-filter:blur(10px);z-index:2400;display:flex;justify-content:center;align-items:center;opacity:0;pointer-events:none;transition:opacity 0.3s;">
        <div
            style="background:var(--surface-color);border:1px solid var(--border-color);border-radius:16px;box-shadow:var(--shadow-lg);padding:2rem;max-width:400px;text-align:center;">
            <h3 style="margin-top:0;">♻️ Rescan Folder</h3>
            <p style="color:var(--text-muted);margin-bottom:1.5rem;">Choose how you want to rescan files in this folder.
            </p>
            <div style="display:flex;flex-direction:column;gap:1rem;">
                <button id="rescan-recent-btn"
                    style="background:var(--primary-color);color:white;border:none;padding:0.75rem;border-radius:8px;cursor:pointer;font-weight:600;">Rescan
                    Outdated (> 1h)</button>
                <button id="rescan-all-btn"
                    style="background:var(--danger-color);color:white;border:none;padding:0.75rem;border-radius:8px;cursor:pointer;font-weight:600;">Rescan
                    All Files</button>
                <button id="rescan-cancel-btn"
                    style="background:var(--surface-hover);color:var(--text-color);border:1px solid var(--border-color);padding:0.75rem;border-radius:8px;cursor:pointer;font-weight:600;">Cancel</button>
            </div>
        </div>
    </div>
    <div id="loader-overlay">
        <div class="loader"></div>
    </div>
    <div id="shortcuts-help-overlay">
        <div class="shortcuts-panel">
            <div class="shortcuts-header">
                <h2>⌨️ Keyboard Shortcuts</h2>
                <button class="close-btn" id="close-shortcuts-btn">×</button>
            </div>
            <div class="shortcuts-content">
                <div class="shortcut-item"><span class="key">?</span> <span class="desc">Show this help</span></div>
                <div class="shortcut-item"><span class="key">←</span> <span class="key">→</span> <span
                        class="key">↑</span> <span class="key">↓</span> <span class="desc">Navigate images</span></div>
                <div class="shortcut-item"><span class="key">V</span> <span class="desc">View image (Lightbox)</span>
                </div>
                <div class="shortcut-item"><span class="key">X</span> <span class="desc">Select / Deselect image</span>
                </div>
                <div class="shortcut-item"><span class="key">F</span> <span class="desc">Favorite / Unfavorite</span>
                </div>
                <div class="shortcut-item"><span class="key">S</span> <span class="desc">Download Image</span></div>
                <div class="shortcut-item"><span class="key">W</span> <span class="desc">Download Workflow (if
                        available)</span></div>
                <div class="shortcut-item"><span class="key">C</span> <span class="desc">Open in Workflow Tool (if
                        available)</span></div>
                <div class="shortcut-item"><span class="key">L</span> <span class="desc">Refresh View</span></div>
                <div class="shortcut-item"><span class="key">K</span> <span class="desc">Rescan Folder</span></div>
                <div class="shortcut-item"><span class="key">R</span> <span class="desc">Rename File</span></div>
                <div class="shortcut-item"><span class="key">Z</span> <span class="desc">Download Zip (Selected)</span>
                </div>
                <div class="shortcut-item"><span class="key">D</span> <span class="desc">Delete (Selected)
                        File(s)</span></div>
                <div class="shortcut-item"><span class="key">Esc</span> <span class="desc">Close Lightbox / Deselect
                        All</span></div>
                <div class="shortcut-item"><span class="key">M</span> <span class="desc">Move Selected Files</span>
                </div>
                <div class="shortcut-item"><span class="desc">Lightbox view:</span></div>
                <div class="shortcut-item"><span class="key">O</span> <span class="desc">Open in New Tab</span></div>
                <div class="shortcut-item"><span class="key">T</span> <span class="desc">Tags (Programs/Campaigns)</span></div>
                <div class="shortcut-item"><span class="key">P</span> <span class="desc">Post to Social</span></div>
                <div class="shortcut-item"><span class="key">+</span> <span class="key">-</span> <span class="desc">Zoom
                        In/Out</span></div>
                <div class="shortcut-item"><span class="key">Keypad (Num 789/456/123)</span> <span class="desc">Pan
                        Diagonally/Up/Down/Left/Right</span></div>
                <div class="shortcut-item"><span class="key">0</span> <span class="desc">Reset Zoom/Pan</span></div>
                <div class="shortcut-item"><span class="key">.</span> <span class="desc">Cycle Pan Step</span></div>
                <div class="shortcut-item"><span class="key">H</span> <span class="desc">Hide Toolbar (5s)</span></div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.4.3/dist/js/tom-select.complete.min.js"></script>
    <script>
        // --- DATA INITIALIZATION AND GLOBAL STATE ---
        const foldersData = {{ folders | tojson }};
        const currentFolderInfo = {{ current_folder_info | tojson }};
        const protectedFolderKeys = {{ protected_folder_keys | tojson }};
        const sharepointFolderNames = {{ sharepoint_folders | default([]) | tojson }};
        const initialFiles = {{ files | tojson }};
        let totalFiles = {{ total_files }};
        let totalFolderFiles = {{ total_folder_files }};
        const currentFolderKey = '{{ current_folder_key }}';
        const ancestorKeys = {{ ancestor_keys | tojson }};
        const socialEnabled = {% if social_enabled is defined and social_enabled and current_user is defined and current_user.is_authenticated %}true{% else %}false{% endif %};
        // Platform limits for social media
        const PLATFORM_LIMITS = {
            instagram: { maxImages: 10, maxVideos: 1, name: 'Instagram' },
            facebook: { maxImages: 10, maxVideos: 1, name: 'Facebook' },
            linkedin: { maxImages: 20, maxVideos: 1, name: 'LinkedIn' }
        };

        const galleryContainer = document.getElementById('gallery-container');
        const selectionBar = document.getElementById('selection-bar');
        const selectionCounter = document.getElementById('selection-counter');
        const loaderOverlay = document.getElementById('loader-overlay');
        const backToTopBtn = document.getElementById('backToTopBtn');
        let currentItemCount = 0;
        let galleryItems = [];
        let allFilesData = [];
        const selectedFiles = new Set();
        let lastSelectedItem = null;
        let currentSearch = { nav: '', move: '' };
        let focusedItemIndex = -1;

        // --- UI STATE PERSISTENCE MANAGEMENT ---
        const savedSort = localStorage.getItem('gallerySortPreference');
        let currentSort = savedSort
            ? JSON.parse(savedSort)
            : { nav: { key: 'name', dir: 'asc' }, move: { key: 'name', dir: 'asc' } };

        const savedFolderState = localStorage.getItem('galleryFolderState');
        const expandedFolderKeys = savedFolderState ? new Set(JSON.parse(savedFolderState)) : new Set();

        // --- FOLDER TREE MANAGEMENT FUNCTIONS ---
        function showNotification(message, type = 'info') { const container = document.getElementById('notification-container'); if (!container) return; const notification = document.createElement('div'); notification.className = `notification ${type}`; notification.textContent = message; container.appendChild(notification); setTimeout(() => { notification.classList.add('show'); }, 10); setTimeout(() => { notification.classList.remove('show'); notification.addEventListener('transitionend', () => notification.remove()); }, 3000); }
        function handleError(error) { console.error('API Error:', error); showNotification(error.message || 'An unexpected network error occurred.', 'error'); }
        function handleGenericResponse(response) { return response.json().then(data => { if (!response.ok) { throw new Error(data.message || `HTTP error! status: ${response.status}`); } if (data.status === 'success' || data.status === 'partial_success') { showNotification(data.message || 'Action completed successfully!', 'success'); setTimeout(() => window.location.reload(), 1200); } else { throw new Error(data.message || 'An unspecified error occurred.'); } }).catch(handleError); }

        function sortChildren(folder, sortKey, direction) {
            if (!folder.children || folder.children.length === 0) return [];
            const dirMultiplier = direction === 'asc' ? 1 : -1;
            return [...folder.children].sort((keyA, keyB) => {
                const folderA = foldersData[keyA];
                const folderB = foldersData[keyB];
                if (!folderA || !folderB) return 0;
                let comparison = 0;
                if (sortKey === 'mtime') {
                    comparison = (folderA.mtime || 0) - (folderB.mtime || 0);
                } else {
                    const nameA = folderA.display_name || '';
                    const nameB = folderB.display_name || '';
                    comparison = nameA.localeCompare(nameB, undefined, { numeric: true, sensitivity: 'base' });
                }
                return comparison * dirMultiplier;
            });
        }

        function buildFolderTreeHTML(folderKey, isMovePanel = false) {
            const folder = foldersData[folderKey];
            if (!folder) return '';
            const hasChildren = folder.children && folder.children.length > 0;
            const isManuallyExpanded = expandedFolderKeys.has(folderKey);
            const isAncestor = ancestorKeys.includes(folderKey);
            const isCollapsed = folderKey !== '_root_' && !isAncestor && !isManuallyExpanded;
            const isActive = !isMovePanel && folderKey === currentFolderKey;

            let childrenHTML = '';
            if (hasChildren) {
                const sortSettings = isMovePanel ? currentSort.move : currentSort.nav;
                const sortedChildren = sortChildren(folder, sortSettings.key, sortSettings.dir);
                childrenHTML = sortedChildren.map(childKey => buildFolderTreeHTML(childKey, isMovePanel)).join('');
            }

            const folderDisplayName = folder.display_name;
            const folderIcon = '📁';
            const isSharePointFolder = sharepointFolderNames.includes(folderDisplayName);
            const spBadge = isSharePointFolder ? '<span class="sp-folder-badge" title="Synced from SharePoint">SP</span>' : '';
            let itemHTML;
            if (isMovePanel) {
                itemHTML = ` <div class="folder-item"> <span class="toggle-btn ${!hasChildren ? 'empty' : ''}"></span> <span class="folder-link" title="${folderDisplayName}">${folderIcon} ${folderDisplayName}${spBadge}</span> <button class="move-here-btn" data-folder-key="${folderKey}" title="Move here" ${folderKey === currentFolderKey ? 'disabled' : ''}>➜</button> </div>`;
            } else {
                itemHTML = ` <div class="folder-item ${isActive ? 'active' : ''}"> <span class="toggle-btn ${!hasChildren ? 'empty' : ''}"></span> <span class="folder-link navigation-link" data-folder-url="/galleryout/view/${folderKey}" title="${folderDisplayName}">${folderIcon} ${folderDisplayName}${spBadge}</span> ${(folderKey !== '_root_' && !protectedFolderKeys.includes(folderKey)) ? `<div class="folder-actions"> <button class="folder-action-btn" title="Rename" data-action="rename" data-name="${folderDisplayName}">✏️</button> <button class="folder-action-btn" title="Delete" data-action="delete" data-name="${folderDisplayName}">🗑️</button> </div>` : ''} </div>`;
            }
            return `<li data-folder-key="${folderKey}" data-folder-name="${folderDisplayName.toLowerCase()}" class="${isCollapsed ? 'collapsed' : ''} ${!hasChildren ? 'no-children' : ''}">${itemHTML}${hasChildren ? `<ul>${childrenHTML}</ul>` : ''}</li>`;
        }

        function renderAllTrees() {
            document.getElementById('folder-tree-nav').innerHTML = buildFolderTreeHTML('_root_', false);
            filterTree('folder-tree-nav', currentSearch.nav, false);
        }

        function filterTree(treeId, searchTerm, saveState = true) {
            const term = searchTerm.toLowerCase().trim();
            const tree = document.getElementById(treeId);
            if (!tree) return;
            const allItems = Array.from(tree.getElementsByTagName('li'));

            allItems.forEach(li => li.classList.remove('is-hidden'));

            if (!term) return;

            let stateChanged = false;
            allItems.forEach(li => li.classList.add('is-hidden'));
            allItems.forEach(li => {
                if (li.dataset.folderName.includes(term)) {
                    li.classList.remove('is-hidden');
                    let parent = li.parentElement.closest('li');
                    while (parent) {
                        parent.classList.remove('is-hidden');
                        if (parent.classList.contains('collapsed')) {
                            parent.classList.remove('collapsed');
                            expandedFolderKeys.add(parent.dataset.folderKey);
                            stateChanged = true;
                        }
                        parent = parent.parentElement.closest('li');
                    }
                }
            });

            if (saveState && stateChanged) {
                localStorage.setItem('galleryFolderState', JSON.stringify([...expandedFolderKeys]));
            }
        }

        function setupFolderControls(navId, treeId) {
            document.getElementById(`folder-search-${navId}`).addEventListener('input', (e) => {
                currentSearch[navId] = e.target.value;
                filterTree(treeId, currentSearch[navId], true);
            });
            const sortContainer = document.getElementById(`folder-sort-${navId}`);
            sortContainer.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;
                const newSortKey = button.dataset.sort;
                const sortTarget = (navId === 'nav') ? currentSort.nav : currentSort.move;

                if (sortTarget.key === newSortKey) {
                    sortTarget.dir = sortTarget.dir === 'asc' ? 'desc' : 'asc';
                } else {
                    sortTarget.key = newSortKey;
                    sortTarget.dir = newSortKey === 'name' ? 'asc' : 'desc';
                }

                updateSortButtonsUI(navId);
                const isMovePanel = navId === 'move';
                document.getElementById(treeId).innerHTML = buildFolderTreeHTML('_root_', isMovePanel);
                filterTree(treeId, currentSearch[navId], false);

                localStorage.setItem('gallerySortPreference', JSON.stringify(currentSort));
            });
            updateSortButtonsUI(navId);
        }

        function updateSortButtonsUI(navId) {
            const sortContainer = document.getElementById(`folder-sort-${navId}`);
            const sortTarget = (navId === 'nav') ? currentSort.nav : currentSort.move;
            sortContainer.querySelectorAll('button').forEach(btn => {
                const sortType = btn.dataset.sort;
                let text = sortType === 'name' ? 'A-Z' : '🗓️';
                btn.classList.remove('active');
                if (sortType === sortTarget.key) {
                    btn.classList.add('active');
                    const arrow = sortTarget.dir === 'asc' ? '↑' : '↓';
                    text += ` ${arrow}`;
                }
                btn.innerHTML = text;
            });
        }

        function setupSidebarExpansion() {
            const btn = document.getElementById('sidebar-expand-btn');
            const textEl = document.getElementById('sidebar-expand-text');
            const body = document.body;

            function updateButtonUI() {
                if (body.classList.contains('sidebar-expanded')) {
                    btn.querySelector('span:first-child').innerHTML = '⬅️';
                    textEl.textContent = 'Collapse';
                    btn.title = 'Collapse Sidebar';
                } else {
                    btn.querySelector('span:first-child').innerHTML = '↔️';
                    textEl.textContent = 'Expand';
                    btn.title = 'Expand Sidebar';
                }
            }

            if (localStorage.getItem('sidebarExpandedState') === 'true') {
                body.classList.add('sidebar-expanded');
            }
            updateButtonUI();

            btn.addEventListener('click', () => {
                body.classList.toggle('sidebar-expanded');

                if (body.classList.contains('sidebar-expanded')) {
                    localStorage.setItem('sidebarExpandedState', 'true');
                } else {
                    localStorage.removeItem('sidebarExpandedState');
                }

                updateButtonUI();
            });
        }

        function startSyncProcess(isManualRefresh = false) { const syncOverlay = document.getElementById('sync-overlay'); const syncMessage = document.getElementById('sync-message'); const syncProgressFill = document.getElementById('sync-progress-fill'); const eventSource = new EventSource(`/galleryout/sync_status/${currentFolderKey}`); let hasChanges = false; if (isManualRefresh) { syncOverlay.style.display = 'flex'; syncMessage.textContent = 'Checking for changes...'; syncProgressFill.style.width = '0%'; syncProgressFill.style.backgroundColor = 'var(--primary-color)'; } const cleanupAndClose = (shouldReload = false) => { eventSource.close(); if (shouldReload) { setTimeout(() => window.location.reload(), 1200); } else { setTimeout(() => { syncOverlay.style.display = 'none'; }, isManualRefresh ? 1200 : 0); } }; eventSource.onmessage = function (event) { try { const data = JSON.parse(event.data); if (!hasChanges && data.status !== 'no_changes') { syncOverlay.style.display = 'flex'; hasChanges = true; } if (syncOverlay.style.display === 'flex') { syncMessage.textContent = data.message; if (data.total > 0) { syncProgressFill.style.width = `${(data.current / data.total) * 100}%`; } } if (data.status === 'no_changes') { if (isManualRefresh) { syncProgressFill.style.width = '100%'; cleanupAndClose(true); } else {cleanupAndClose(false); }} else if (data.status === 'reloading') { cleanupAndClose(true); } else if (data.error) { syncProgressFill.style.backgroundColor = 'var(--danger-color)'; cleanupAndClose(false); } } catch (e) { console.error("Error parsing SSE data:", e); cleanupAndClose(false); } }; eventSource.onerror = function () { eventSource.close(); }; }
        function formatBytes(bytes, decimals = 1) { if (!bytes) return '0 B'; const k = 1024; const dm = decimals < 0 ? 0 : decimals; const sizes = ['B', 'KB', 'MB', 'GB', 'TB']; const i = Math.floor(Math.log(bytes) / Math.log(k)); return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i]; }
        function appendFiles(files) { if (!files || files.length === 0) { if (currentItemCount === 0) showEmptyState(); updateLoadMoreVisibility(); return; } const fragment = document.createDocumentFragment(); const newLazyElements = []; files.forEach(file => { allFilesData.push(file); const item = createGalleryItem(file); fragment.appendChild(item); galleryItems.push(item); const lazyEl = item.querySelector('.lazy'); if (lazyEl) newLazyElements.push(lazyEl); }); galleryContainer.appendChild(fragment); initializeLazyLoading(newLazyElements); currentItemCount += files.length; updateLoadMoreVisibility(); }
        function createGalleryItem(file) {
            const item = document.createElement('div');
            item.className = 'gallery-item';
            item.dataset.fileId = file.id;
            item.dataset.fileType = file.type;
            item.setAttribute('draggable', 'true');
            item.addEventListener('dragstart', (event) => dragStart(event, file.id));
            let mediaHTML = '';
            if (file.type === 'audio') {
                mediaHTML = `<div style="display:flex;align-items:center;justify-content:center;height:100%;font-size:4rem;color:#1ed760;">🎵</div>`;
            } else if (['image', 'animated_image'].includes(file.type)) {
                mediaHTML = `<img class="lazy" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1 1'%3E%3C/svg%3E" data-src="/galleryout/thumbnail/${file.id}" alt="${file.name}" loading="lazy">`;
            } else if (file.type === 'video') {
                mediaHTML = `<video autoplay muted loop playsinline class="lazy" data-src="/galleryout/file/${file.id}" poster="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1 1'%3E%3C/svg%3E"></video>`;
            } else {
                mediaHTML = `<div style="display:flex;align-items:center;justify-content:center;height:100%;font-size:3rem;color:var(--text-muted);">📄</div>`;
            }
            const socialPostBtnHTML = socialEnabled ? `<button class="social-post-btn" title="Post to Social" onclick="quickPost(event, '${file.id}')" style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);">📤</button>` : '';
            let metadataHTML = '';
            if (file.dimensions || file.mtime || file.size) {
                const date = new Date(file.mtime * 1000);
                const formattedDate = date.toLocaleString(undefined, { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                const dimensionsPart = file.dimensions ? `<span>📐 ${file.dimensions}</span>` : '';
                const datePart = file.mtime ? `<span>📅 ${formattedDate}</span>` : '';
                const sizePart = file.size ? `<span>💾 ${formatBytes(file.size)}</span>` : '';
                metadataHTML = `<div class="file-metadata">${dimensionsPart}${sizePart}${datePart}</div>`;
            }

            let scannedHTML = '';
            if (file.last_scanned) {
                const scannedDate = new Date(file.last_scanned * 1000);
                const formattedScannedDate = scannedDate.toLocaleString(undefined, { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                scannedHTML = `<div class="file-scanned-time" style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; opacity: 0.8;">🔍 Scanned: ${formattedScannedDate}</div>`;
            }

            item.innerHTML = `<div class="selection-checkmark" onclick="toggleSelection(event, '${file.id}', this.closest('.gallery-item'))">✓</div><div class="thumbnail-link" onclick="openLightbox(event, '${file.id}'); event.stopPropagation();" draggable="false"><div class="thumbnail-wrapper">${mediaHTML}${file.duration ? `<span class="duration-overlay">⏱️ ${file.duration}</span>` : ''}</div></div><div class="item-info"><div><p title="${file.name}"><strong>${file.name}</strong></p>${metadataHTML}${scannedHTML}</div><div class="item-actions">${socialPostBtnHTML}<button class="favorite-btn ${file.is_favorite ? 'favorited' : ''}" title="Favorite" onclick="toggleFavorite(event, '${file.id}', this)">${file.is_favorite ? '⭐' : '☆'}</button><a href="/galleryout/download/${file.id}" onclick="event.stopPropagation()" title="Download">💾</a><button class="delete-btn" onclick="deleteFile(event, '${file.id}', this)">🗑️</button></div></div>`;
            return item;
        }
        function updateLoadMoreVisibility() { const loadMoreContainer = document.getElementById('load-more-container'); if (!loadMoreContainer) return; const shouldHide = currentItemCount >= totalFiles || totalFiles === 0; loadMoreContainer.style.display = shouldHide ? 'none' : 'block'; }
        function updateFileCountBadge() { const fileCountBadge = document.querySelector('.file-count-badge'); if (!fileCountBadge) return; const displayCount = galleryItems.length; totalFiles = displayCount; totalFolderFiles--; const showTotal = totalFiles !== totalFolderFiles; fileCountBadge.textContent = `📂 ${displayCount} File${displayCount !== 1 ? 's' : ''}${showTotal ? ` (${totalFolderFiles} Total)` : ''}`; }
        function showEmptyState() { galleryContainer.innerHTML = `<div class="empty-state" style="grid-column: 1/-1;"><h3>📭 No files found</h3><p>There are no files matching your criteria in this folder.</p></div>`; }
        function initializeLazyLoading(elements) { const observer = new IntersectionObserver((entries, obs) => { entries.forEach(entry => { if (entry.isIntersecting) { const el = entry.target; if (el.dataset.src) { el.src = el.dataset.src; if (el.tagName === "VIDEO") el.load(); } el.classList.remove("lazy"); obs.unobserve(el); } }); }, { rootMargin: '50px' }); elements.forEach(el => observer.observe(el)); }
        function createFolder() { const folderName = prompt("📁 Enter a name for the new folder:"); if (folderName && folderName.trim()) { fetch('/galleryout/create_folder', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ folder_name: folderName.trim(), parent_key: currentFolderKey }) }).then(handleGenericResponse).catch(handleError); } }
        function renameFolder(event, folderKey, oldName) { event.stopPropagation(); const newName = prompt("✏️ Enter the new name for the folder:", oldName); if (newName && newName.trim() && newName.trim() !== oldName) { fetch(`/galleryout/rename_folder/${folderKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ new_name: newName.trim() }) }).then(handleGenericResponse).catch(handleError); } }
        function deleteFolder(event, folderKey, folderName) { event.stopPropagation(); if (confirm(`🗑️ Delete the folder "${folderName}" and all its contents? This cannot be undone.`)) { fetch(`/galleryout/delete_folder/${folderKey}`, { method: 'POST' }).then(handleGenericResponse).catch(handleError); } }

        // --- START MODIFICATION: Sync sort on "Move" panel opening ---
        function populateAndShowDropPanel() {
            // Sync the 'move' panel's sort state with the 'nav' panel's state
            currentSort.move = { ...currentSort.nav };

            document.getElementById('drag-drop-overlay').classList.add('visible');
            document.getElementById('drop-zone-panel').classList.add('visible');

            // Update the move panel's sort buttons UI to reflect the synced state
            updateSortButtonsUI('move');

            document.getElementById('move-folder-tree').innerHTML = buildFolderTreeHTML('_root_', true);
            filterTree('move-folder-tree', currentSearch.move, false);
        }
        // --- END MODIFICATION ---

        function confirmMoveToFolder(folderKey) { if (!selectedFiles || selectedFiles.size === 0) { showNotification('No files selected.', 'warning'); return; } performBatchAction('/galleryout/move_batch', { file_ids: [...selectedFiles], destination_folder: folderKey }); hideDropZone(); }
        function hideDropZone() { document.getElementById('drag-drop-overlay').classList.remove('visible'); document.getElementById('drop-zone-panel').classList.remove('visible'); }
        function dragStart(event, fileId) { event.stopPropagation(); if (!selectedFiles.has(fileId)) { deselectAll(); selectedFiles.add(fileId); updateSelectionUI(); } const dragImage = document.createElement('div'); dragImage.style.cssText = `position:absolute;top:-100px;background:var(--primary-color);color:white;padding:8px 16px;border-radius:8px;font-weight:600;`; dragImage.textContent = `📦 ${selectedFiles.size} file${selectedFiles.size !== 1 ? 's' : ''}`; document.body.appendChild(dragImage); event.dataTransfer.setDragImage(dragImage, 0, 0); setTimeout(() => document.body.removeChild(dragImage), 0); event.dataTransfer.setData('text/plain', [...selectedFiles].join(',')); populateAndShowDropPanel(); }
        function toggleSelection(event, fileId, item) {
            event.stopPropagation();

            // Sync keyboard focus with mouse selection
            const newIndex = galleryItems.indexOf(item);
            if (newIndex !== -1) {
                if (focusedItemIndex !== -1 && galleryItems[focusedItemIndex]) {
                    galleryItems[focusedItemIndex].classList.remove('focused');
                }
                focusedItemIndex = newIndex;
                galleryItems[focusedItemIndex].classList.add('focused');
            }

            const isShift = event.shiftKey;
            if (isShift && lastSelectedItem) {
                const lastIndex = galleryItems.findIndex(i => i.dataset.fileId === lastSelectedItem.dataset.fileId);
                const currentIndex = galleryItems.findIndex(i => i.dataset.fileId === fileId);
                const [start, end] = [lastIndex, currentIndex].sort((a, b) => a - b);
                for (let i = start; i <= end; i++) {
                    selectedFiles.add(galleryItems[i].dataset.fileId);
                }
            } else {
                selectedFiles.has(fileId) ? selectedFiles.delete(fileId) : selectedFiles.add(fileId);
                lastSelectedItem = item;
            }
            updateSelectionUI();
        }
        function updateSelectionUI() {
            galleryItems.forEach(item => { item.classList.toggle('selected', selectedFiles.has(item.dataset.fileId)); });
            const count = selectedFiles.size;
            selectionCounter.textContent = `📊 ${count} file${count !== 1 ? 's' : ''} selected`;
            selectionBar.classList.toggle('visible', count > 0);

            // Compare button logic - show when 2+ files selected
            const compareBtn = document.getElementById('compare-btn');
            compareBtn.style.display = count >= 2 ? 'inline-block' : 'none';

            // Range button logic
            const rangeBtn = document.getElementById('range-select-btn');
            if (count === 2) {
                const selectedIds = Array.from(selectedFiles);
                const index1 = galleryItems.findIndex(item => item.dataset.fileId === selectedIds[0]);
                const index2 = galleryItems.findIndex(item => item.dataset.fileId === selectedIds[1]);
                if (index1 !== -1 && index2 !== -1 && Math.abs(index1 - index2) > 1) {
                    rangeBtn.style.display = 'inline-block';
                    rangeBtn.onclick = () => selectRange(index1, index2);
                } else {
                    rangeBtn.style.display = 'none';
                }
            } else {
                rangeBtn.style.display = 'none';
            }

            // Platform warnings for social posting
            const warningsContainer = document.getElementById('platform-warnings');
            if (warningsContainer && socialEnabled && count > 0) {
                const warnings = getPlatformWarnings();
                if (warnings.length > 0) {
                    warningsContainer.innerHTML = warnings.map(w => `<span class="platform-warning">⚠️ ${w}</span>`).join('');
                    warningsContainer.classList.add('visible');
                } else {
                    warningsContainer.innerHTML = '';
                    warningsContainer.classList.remove('visible');
                }
            } else if (warningsContainer) {
                warningsContainer.innerHTML = '';
                warningsContainer.classList.remove('visible');
            }
        }
        function selectRange(index1, index2) {
            const start = Math.min(index1, index2);
            const end = Math.max(index1, index2);
            for (let i = start + 1; i < end; i++) {
                if (galleryItems[i]) {
                    selectedFiles.add(galleryItems[i].dataset.fileId);
                }
            }
            updateSelectionUI();
        }
        function selectAll() { galleryItems.forEach(item => selectedFiles.add(item.dataset.fileId)); lastSelectedItem = galleryItems.length > 0 ? galleryItems[galleryItems.length - 1] : null; updateSelectionUI(); }
        function deselectAll() { selectedFiles.clear(); lastSelectedItem = null; updateSelectionUI(); }
        function toggleFavorite(event, fileId, element) { event.stopPropagation(); const originalContent = element.innerHTML; element.innerHTML = '⏳'; element.disabled = true; fetch(`/galleryout/toggle_favorite/${fileId}`, { method: 'POST' }).then(res => res.json()).then(data => { if (data.status === 'success') { element.classList.toggle('favorited', data.is_favorite); element.innerHTML = data.is_favorite ? '⭐' : '☆'; showNotification(data.is_favorite ? 'Added to favorites!' : 'Removed from favorites!', 'success'); } else { element.innerHTML = originalContent; showNotification('Error toggling favorite', 'error'); } }).catch(error => { element.innerHTML = originalContent; handleError(error); }).finally(() => element.disabled = false); }
        function deleteFile(event, fileId, element) { event.stopPropagation(); if (!confirm('🗑️ Delete this file? This cannot be undone.')) return; const item = element.closest('.gallery-item'); element.disabled = true; fetch(`/galleryout/delete/${fileId}`, { method: 'POST' }).then(res => res.json()).then(data => { if (data.status === 'success') { item.style.transition = 'all 0.4s ease'; item.style.opacity = '0'; item.style.transform = 'scale(0.8)'; showNotification('File deleted!', 'success'); setTimeout(() => { item.remove(); galleryItems = galleryItems.filter(gi => gi !== item); allFilesData = allFilesData.filter(f => f.id !== fileId); selectedFiles.delete(fileId); updateSelectionUI(); currentItemCount--; updateFileCountBadge(); updateLoadMoreVisibility(); }, 400); } else { showNotification(`Error: ${data.message || 'Deletion failed'}`, 'error'); element.disabled = false; } }).catch(error => { handleError(error); element.disabled = false; }); }
        function moveSelected() { if (selectedFiles.size > 0) populateAndShowDropPanel(); }
        function deleteSelected() { const count = selectedFiles.size; if (count > 0 && confirm(`🗑️ Delete ${count} files? This cannot be undone.`)) { performBatchAction('/galleryout/delete_batch', { file_ids: [...selectedFiles] }); } }
        function favoriteSelected(status) { if (selectedFiles.size === 0) return; performBatchAction('/galleryout/favorite_batch', { file_ids: [...selectedFiles], status: status }); }
        function performBatchAction(url, body) { fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) }).then(handleGenericResponse).catch(handleError); }
        function postSelectedToSocial() {
            if (selectedFiles.size === 0) { showNotification('Select at least one file first.', 'warning'); return; }
            const fileIds = [...selectedFiles].join(',');
            window.location.href = '/galleryout/social/compose?file_ids=' + encodeURIComponent(fileIds);
        }
        function quickPost(event, fileId) {
            event.stopPropagation();
            window.location.href = '/galleryout/social/compose?file_ids=' + encodeURIComponent(fileId) + '&quick=1';
        }
        function postFromLightbox(fileId) {
            window.location.href = '/galleryout/social/compose?file_ids=' + encodeURIComponent(fileId) + '&quick=1';
        }

        // --- TAGS PANEL FUNCTIONS ---
        let allPrograms = [];
        let allCampaigns = [];
        let currentFilePrograms = [];
        let currentFileCampaigns = [];

        async function openTagsPanel(fileId) {
            const overlay = document.getElementById('tags-overlay');
            if (!overlay) return;

            document.getElementById('tags-file-id').value = fileId;
            overlay.classList.add('visible');

            // Show loading state
            document.getElementById('programs-list').innerHTML = '<div class="loading-spinner">Loading...</div>';
            document.getElementById('campaigns-list').innerHTML = '<div class="loading-spinner">Loading...</div>';

            try {
                // Fetch all programs and campaigns in parallel with file's current assignments
                const [programsRes, campaignsRes, fileTagsRes] = await Promise.all([
                    fetch('/galleryout/social/api/programs'),
                    fetch('/galleryout/social/api/campaigns'),
                    fetch(`/galleryout/social/files/${fileId}/categories`)
                ]);

                allPrograms = await programsRes.json();
                allCampaigns = await campaignsRes.json();
                const fileTags = await fileTagsRes.json();

                currentFilePrograms = fileTags.programs.map(p => p.id);
                currentFileCampaigns = fileTags.campaigns.map(c => c.id);

                renderTagsList('programs-list', allPrograms, currentFilePrograms);
                renderTagsList('campaigns-list', allCampaigns, currentFileCampaigns);
            } catch (error) {
                console.error('Error loading tags:', error);
                showNotification('Error loading tags', 'error');
            }
        }

        function renderTagsList(containerId, items, selectedIds) {
            const container = document.getElementById(containerId);
            if (items.length === 0) {
                container.innerHTML = '<div class="tags-empty">No items available</div>';
                return;
            }

            container.innerHTML = items.map(item => {
                const isSelected = selectedIds.includes(item.id);
                return `
                    <label class="tag-item ${isSelected ? 'selected' : ''}" data-id="${item.id}">
                        <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleTagItem(this)">
                        <span>${item.name}</span>
                    </label>
                `;
            }).join('');
        }

        function toggleTagItem(checkbox) {
            const tagItem = checkbox.closest('.tag-item');
            tagItem.classList.toggle('selected', checkbox.checked);
        }

        function closeTagsPanel() {
            const overlay = document.getElementById('tags-overlay');
            if (overlay) {
                overlay.classList.remove('visible');
            }
        }

        async function saveFileTags() {
            const fileId = document.getElementById('tags-file-id').value;
            const saveBtn = document.getElementById('tags-save-btn');
            const originalText = saveBtn.textContent;
            saveBtn.textContent = 'Saving...';
            saveBtn.disabled = true;

            // Collect selected programs and campaigns
            const selectedPrograms = [];
            const selectedCampaigns = [];

            document.querySelectorAll('#programs-list .tag-item input:checked').forEach(cb => {
                selectedPrograms.push(cb.closest('.tag-item').dataset.id);
            });
            document.querySelectorAll('#campaigns-list .tag-item input:checked').forEach(cb => {
                selectedCampaigns.push(cb.closest('.tag-item').dataset.id);
            });

            try {
                const response = await fetch(`/galleryout/social/files/${fileId}/categories`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        programs: selectedPrograms,
                        campaigns: selectedCampaigns
                    })
                });

                const result = await response.json();
                if (result.success) {
                    showNotification('Tags saved successfully!', 'success');
                    closeTagsPanel();
                } else {
                    showNotification('Error saving tags', 'error');
                }
            } catch (error) {
                console.error('Error saving tags:', error);
                showNotification('Error saving tags', 'error');
            } finally {
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
            }
        }

        // Initialize tags panel event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const closeTagsBtn = document.getElementById('close-tags-btn');
            const cancelTagsBtn = document.getElementById('tags-cancel-btn');
            const saveTagsBtn = document.getElementById('tags-save-btn');
            const tagsOverlay = document.getElementById('tags-overlay');

            if (closeTagsBtn) closeTagsBtn.addEventListener('click', closeTagsPanel);
            if (cancelTagsBtn) cancelTagsBtn.addEventListener('click', closeTagsPanel);
            if (saveTagsBtn) saveTagsBtn.addEventListener('click', saveFileTags);
            if (tagsOverlay) {
                tagsOverlay.addEventListener('click', function(e) {
                    if (e.target === tagsOverlay) closeTagsPanel();
                });
            }
        });

        function getPlatformWarnings() {
            const count = selectedFiles.size;
            const warnings = [];
            // Count images vs videos
            let imageCount = 0, videoCount = 0;
            selectedFiles.forEach(fileId => {
                const item = document.querySelector(`.gallery-item[data-file-id="${fileId}"]`);
                if (item) {
                    const type = item.dataset.fileType;
                    if (type === 'video') videoCount++;
                    else imageCount++;
                }
            });
            // Check platform limits
            if (videoCount > 1) {
                warnings.push('Most platforms only support 1 video per post');
            }
            if (count > PLATFORM_LIMITS.instagram.maxImages) {
                warnings.push(`Instagram limit: ${PLATFORM_LIMITS.instagram.maxImages} items`);
            }
            if (count > PLATFORM_LIMITS.linkedin.maxImages) {
                warnings.push(`LinkedIn limit: ${PLATFORM_LIMITS.linkedin.maxImages} images`);
            }
            if (imageCount > 0 && videoCount > 0) {
                warnings.push('Mixing images and video may not work on all platforms');
            }
            return warnings;
        }
        function downloadSelectedZip() {
            if (selectedFiles.size === 0) return;
            const fileIds = [...selectedFiles];
            
            showNotification('Generating zip file in background...', 'info');

            fetch('/galleryout/prepare_batch_zip', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ file_ids: fileIds })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    pollZipStatus(data.job_id);
                } else {
                    showNotification('Error starting zip: ' + data.message, 'error');
                }
            })
            .catch(handleError);
        }

        function pollZipStatus(jobId) {
            const interval = setInterval(() => {
                fetch(`/galleryout/check_zip_status/${jobId}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === 'ready') {
                            clearInterval(interval);
                            // Creiamo una notifica speciale persistente con il link
                            showDownloadNotification(data.download_url, data.filename);
                        } else if (data.status === 'error') {
                            clearInterval(interval);
                            showNotification('Zip generation failed: ' + data.message, 'error');
                        }
                        // if 'processing', keep waiting
                    })
                    .catch(err => {
                        clearInterval(interval);
                        console.error(err);
                    });
            }, 2000); // Check every 2 secs
        }

        function showDownloadNotification(url, filename) {
            const container = document.getElementById('notification-container');
            if (!container) return;
            
            const notification = document.createElement('div');
            notification.className = 'notification success';
            notification.style.display = 'flex';
            notification.style.flexDirection = 'column';
            notification.style.gap = '10px';
            
            const text = document.createElement('span');
            text.textContent = '📦 Zip archive is ready!';
            
            const btn = document.createElement('a');
            btn.href = url;
            btn.textContent = 'Download Now';
            btn.style.backgroundColor = 'white';
            btn.style.color = 'var(--success-color)';
            btn.style.padding = '5px 10px';
            btn.style.borderRadius = '4px';
            btn.style.textDecoration = 'none';
            btn.style.fontWeight = 'bold';
            btn.style.textAlign = 'center';
            btn.style.cursor = 'pointer';
            
            // By clicking onload and close the notification after a bit
            btn.onclick = (e) => {
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 500);
                }, 1000);
            };

            notification.appendChild(text);
            notification.appendChild(btn);
            
            container.appendChild(notification);
            
            // Animation entry
            setTimeout(() => notification.classList.add('show'), 10);
            
            // Does not disappear automaticly after 3 seconds, 
            // stays till the user downloads or closes it
            setTimeout(() => {
                if(document.body.contains(notification)) {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 500);
                }
            }, 60000); // Disappear after 60 secs if ignored
        }
        const lightboxOverlay = document.getElementById('lightbox-overlay'); const lightboxMedia = document.getElementById('lightbox-media'); const lightboxTitle = document.getElementById('lightbox-title'); const lightboxDownload = document.getElementById('lightbox-download'); const lightboxNewTab = document.getElementById('lightbox-new-tab'); let currentLightboxIndex = -1; let currentLightboxFile = null; let currentZoom = 1; let currentTranslateX = 0; let currentTranslateY = 0; let panStep = 50;
        function updateLightboxTitle() { if (!currentLightboxFile) return; const zoomPercentage = Math.round(currentZoom * 100); lightboxTitle.textContent = `${currentLightboxFile.name} (${zoomPercentage}%)`; }
        function updateMediaTransform() { const mediaEl = lightboxMedia.querySelector('img, video'); if (!mediaEl) return; mediaEl.style.transform = `translate(${currentTranslateX}px, ${currentTranslateY}px) scale(${currentZoom})`; updateLightboxTitle(); }
        function openLightbox(event, fileId) { if (event.target.closest('a, button')) return; event.stopPropagation(); currentLightboxIndex = galleryItems.findIndex(item => item.dataset.fileId === fileId); if (currentLightboxIndex === -1) return; currentZoom = 1; currentTranslateX = 0; currentTranslateY = 0; panStep = 50; document.body.classList.add('lightbox-open'); lightboxOverlay.classList.add('visible'); showItemAtIndex(currentLightboxIndex); }
        function closeLightbox() {
            const mediaElement = lightboxMedia.querySelector('video, audio');
            if (mediaElement) mediaElement.pause();

            // Sync grid focus with lightbox position
            if (currentLightboxIndex !== -1 && galleryItems.length > 0) {
                if (focusedItemIndex !== -1 && galleryItems[focusedItemIndex]) {
                    galleryItems[focusedItemIndex].classList.remove('focused');
                }
                focusedItemIndex = currentLightboxIndex;
                const newItem = galleryItems[focusedItemIndex];
                if (newItem) {
                    newItem.classList.add('focused');
                    newItem.scrollIntoView({ behavior: 'auto', block: 'center' });
                }
            }

            document.body.classList.remove('lightbox-open');
            lightboxOverlay.classList.remove('visible');
            lightboxMedia.innerHTML = '';
            currentLightboxIndex = -1;
            currentLightboxFile = null;
        }

function showItemAtIndex(index) {
            const item = galleryItems[index];
            if (!item) return;
            
            const file = allFilesData.find(f => f.id === item.dataset.fileId);
            if (!file) return;
            
            currentLightboxFile = file;
            updateLightboxTitle();
            
            // Clear the container
            lightboxMedia.innerHTML = '';
            
            let mediaEl;
            const isImage = ['image', 'animated_image'].includes(file.type);

            // Create element based on type
            if (file.type === 'audio') {
                mediaEl = document.createElement('audio');
                mediaEl.src = `/galleryout/file/${file.id}`;
                mediaEl.controls = true;
                mediaEl.autoplay = true;
            } else if (isImage) {
                mediaEl = document.createElement('img');
                mediaEl.src = `/galleryout/file/${file.id}`;
                mediaEl.alt = file.name;
            } else if (file.type === 'video') {
                mediaEl = document.createElement('video');
                mediaEl.src = `/galleryout/file/${file.id}`;
                mediaEl.controls = true;
                mediaEl.autoplay = true;
                mediaEl.loop = true;
                // Apply saved playback speed
                const savedSpeed = parseFloat(localStorage.getItem('videoPlaybackSpeed')) || 1;
                mediaEl.playbackRate = savedSpeed;
                showSpeedControl(true);
            }

            // Hide speed control for non-video content
            if (file.type !== 'video') {
                showSpeedControl(false);
            }

            if (mediaEl) {
                // --- OPTIMIZED LOADING LOGIC ---
                
                // Helper function to reveal media and apply zoom
                const showMedia = () => {
                    const loader = lightboxMedia.querySelector('.lightbox-loader');
                    if (loader) loader.remove();
                    mediaEl.style.opacity = '1';
                    updateMediaTransform();
                };

                // CASE 1: Image is already cached (Instant load)
                // If .complete is true, the browser has the image data ready.
                // We skip the loader and the fade-in animation entirely for a snappy feel.
                if (isImage && mediaEl.complete) {
                    mediaEl.style.opacity = '1'; // Visible immediately
                    lightboxMedia.appendChild(mediaEl);
                    updateMediaTransform();
                } 
                // CASE 2: Needs loading (Show Loader + Fast Fade-in)
                else {
                    // Insert the loader spinner
                    const loader = document.createElement('div');
                    loader.className = 'lightbox-loader';
                    lightboxMedia.appendChild(loader);

                    // Initially hide the media
                    mediaEl.style.opacity = '0';
                    // Reduced transition to 0.15s for a snappier feel
                    mediaEl.style.transition = 'opacity 0.15s ease-out'; 

                    if (isImage) {
                        mediaEl.onload = showMedia;
                    } else {
                        // Logic for Video/Audio
                        mediaEl.onloadeddata = showMedia;
                        mediaEl.onerror = () => {
                            if (loader) loader.remove();
                            lightboxMedia.innerHTML = `<div style="color:var(--danger-color);">Error loading media</div>`;
                        };
                    }
                    
                    lightboxMedia.appendChild(mediaEl);
                }

                // Safety check: re-apply transform to ensure zoom is correct
                requestAnimationFrame(() => updateMediaTransform());

            } else {
                lightboxMedia.innerHTML = `<div style="color:white;font-size:1.2rem;text-align:center;">📄<br>Preview not available</div>`;
            }
            
            // Update toolbar links and buttons
            lightboxDownload.href = `/galleryout/download/${file.id}`;
            lightboxNewTab.href = `/galleryout/file/${file.id}`;

            // Set up tags button
            const tagsBtn = document.getElementById('lightbox-tags-btn');
            if (tagsBtn) {
                tagsBtn.onclick = (event) => {
                    event.stopPropagation();
                    openTagsPanel(file.id);
                };
            }

            // Set up social post button
            const socialBtn = document.getElementById('lightbox-social-btn');
            if (socialBtn) {
                socialBtn.onclick = (event) => {
                    event.stopPropagation();
                    postFromLightbox(file.id);
                };
            }
        }
        
        function navigateLightbox(direction) { if (galleryItems.length === 0) return; currentLightboxIndex = (currentLightboxIndex + direction + galleryItems.length) % galleryItems.length; showItemAtIndex(currentLightboxIndex); }
        function zoomLightbox(amount) { const mediaEl = lightboxMedia.querySelector('img, video'); if (!mediaEl) return; currentZoom = Math.max(0.1, Math.min(10, currentZoom + amount)); panLightbox(0, 0); }

        // --- PLAYBACK SPEED FUNCTIONS ---
        function applyVideoSpeed(speed) {
            const videoEl = lightboxMedia.querySelector('video');
            if (videoEl) {
                videoEl.playbackRate = speed;
            }
        }

        function showSpeedControl(show) {
            const speedControl = document.getElementById('speed-control');
            if (speedControl) {
                if (show) {
                    speedControl.classList.add('visible');
                } else {
                    speedControl.classList.remove('visible');
                }
            }
        }

        function panLightbox(dx, dy) {
            const mediaEl = lightboxMedia.querySelector('img, video');
            if (!mediaEl) return;

            const vw = window.innerWidth;
            const vh = window.innerHeight;
            const iw = mediaEl.offsetWidth * currentZoom;
            const ih = mediaEl.offsetHeight * currentZoom;

            const maxTx = Math.max(0, (iw - vw) / 2);
            const maxTy = Math.max(0, (ih - vh) / 2);

            let newTx = currentTranslateX + dx;
            let newTy = currentTranslateY + dy;

            currentTranslateX = Math.max(-maxTx, Math.min(maxTx, newTx));
            currentTranslateY = Math.max(-maxTy, Math.min(maxTy, newTy));

            updateMediaTransform();
        }
        function cyclePanStep() { panStep += 50; if (panStep > 200) panStep = 50; showNotification(`Pan step: ${panStep}px`, 'info'); }
        let toolbarTimeout;
        function hideToolbarTemporary() {
            const header = document.getElementById('lightbox-header');
            if (!header) return;
            header.style.transition = 'opacity 0.3s';
            header.style.opacity = '0';
            header.style.pointerEvents = 'none';
            if (toolbarTimeout) clearTimeout(toolbarTimeout);
            toolbarTimeout = setTimeout(() => {
                header.style.opacity = '1';
                header.style.pointerEvents = 'auto';
            }, 5000);
        }
        function deleteFromLightbox(noConfirm = false) { if (currentLightboxIndex < 0 || currentLightboxIndex >= galleryItems.length) return; const itemToDelete = galleryItems[currentLightboxIndex]; const fileId = itemToDelete.dataset.fileId; const deleteBtn = document.getElementById('lightbox-delete-btn'); const proceedWithDelete = () => { deleteBtn.disabled = true; fetch(`/galleryout/delete/${fileId}`, { method: 'POST' }).then(res => res.json().then(data => ({ ok: res.ok, data }))).then(({ ok, data }) => { if (ok && data.status === 'success') { showNotification(data.message || 'File deleted!', 'success'); itemToDelete.remove(); galleryItems.splice(currentLightboxIndex, 1); allFilesData = allFilesData.filter(f => f.id !== fileId); currentItemCount--; updateFileCountBadge(); if (galleryItems.length === 0) { closeLightbox(); showEmptyState(); } else { if (currentLightboxIndex >= galleryItems.length) { currentLightboxIndex = galleryItems.length - 1; } showItemAtIndex(currentLightboxIndex); } } else { throw new Error(data.message || 'Deletion failed on the server.'); } }).catch(handleError).finally(() => { if (deleteBtn) { deleteBtn.disabled = false; } }); }; if (noConfirm || confirm('🗑️ Are you sure you want to delete this file? This cannot be undone.')) { proceedWithDelete(); } }

        // --- SEND TO WORKFLOW TOOL FEATURE ---

        function sendToComfyUI(fileId, action = 'load') {
            const btn = document.getElementById('lightbox-send-comfyui');
            if (btn) btn.disabled = true;

            showNotification('Loading workflow...', 'info');

            fetch(`/galleryout/send_to_comfyui/${fileId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: action })
            })
            .then(response => response.json().then(data => ({ ok: response.ok, status: response.status, data })))
            .then(({ ok, status, data }) => {
                if (ok && data.status === 'success') {
                    if (action === 'queue') {
                        showNotification(`Workflow queued! (Queue #${data.number || 'N/A'})`, 'success');
                    } else if (action === 'load') {
                        // Copy workflow to clipboard
                        const workflowJson = JSON.stringify(data.workflow);
                        navigator.clipboard.writeText(workflowJson).then(() => {
                            const comfyUrl = data.comfyui_url || 'http://127.0.0.1:8188';
                            window.open(comfyUrl, '_blank');
                            showNotification('Workflow copied to clipboard!', 'success');
                        }).catch(err => {
                            console.error('Clipboard error:', err);
                            // Fallback: open workflow tool
                            const comfyUrl = data.comfyui_url || 'http://127.0.0.1:8188';
                            window.open(comfyUrl, '_blank');
                            showNotification('Workflow tool opened. Drag the file to load the workflow.', 'info');
                        });
                    }
                } else if (status === 503) {
                    showNotification('Workflow tool is not running or not reachable.', 'error');
                } else if (data.suggestion === 'load') {
                    if (confirm('This workflow is in UI format and cannot be queued directly.\n\nWould you like to open the workflow tool instead?')) {
                        sendToComfyUI(fileId, 'load');
                    }
                } else {
                    throw new Error(data.message || 'Failed to send workflow.');
                }
            })
            .catch(error => {
                console.error('Send workflow error:', error);
                showNotification(error.message || 'Failed to send workflow.', 'error');
            })
            .finally(() => {
                if (btn) btn.disabled = false;
            });
        }

        function sendCurrentToComfyUI() {
            if (!currentLightboxFile || !currentLightboxFile.has_workflow) {
                showNotification('No workflow available for this file.', 'info');
                return;
            }
            sendToComfyUI(currentLightboxFile.id);
        }

        // --- NEW FEATURE: RENAME FILE FROM LIGHTBOX ---

        function renameFile(fileId, currentName) {
            const lastDotIndex = currentName.lastIndexOf('.');
            const baseName = lastDotIndex > -1 ? currentName.substring(0, lastDotIndex) : currentName;
            const extension = lastDotIndex > -1 ? currentName.substring(lastDotIndex) : '';

            const newBaseName = prompt("Enter the new file name (extension will be preserved):", baseName);

            if (newBaseName === null || newBaseName.trim() === '' || newBaseName.trim() === baseName) {
                return;
            }

            const newName = newBaseName.trim() + extension;

            fetch(`/galleryout/rename_file/${fileId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ new_name: newName })
            })
                .then(response => response.json().then(data => ({ ok: response.ok, data })))
                .then(({ ok, data }) => {
                    if (ok && data.status === 'success') {
                        showNotification(data.message, 'success');

                        const newId = data.new_id;

                        // 1. Update the main data array
                        const fileIndexInData = allFilesData.findIndex(f => f.id === fileId);
                        if (fileIndexInData !== -1) {
                            allFilesData[fileIndexInData].name = data.new_name;
                            allFilesData[fileIndexInData].id = newId;

                            // If this file is currently in lightbox, update it
                            if (currentLightboxFile && currentLightboxFile.id === fileId) {
                                currentLightboxFile.name = data.new_name;
                                currentLightboxFile.id = newId;
                                updateLightboxTitle();
                            }
                        }

                        // 2. Update the gallery item in the DOM
                        // We need to find the item by the OLD fileId
                        const galleryItem = document.querySelector(`.gallery-item[data-file-id="${fileId}"]`);
                        if (galleryItem) {
                            galleryItem.dataset.fileId = newId;
                            galleryItem.querySelector('.item-info p strong').textContent = data.new_name;
                            galleryItem.querySelector('.item-info p').title = data.new_name;

                            // Update all handlers to use the new ID
                            galleryItem.querySelector('.thumbnail-link').setAttribute('onclick', `openLightbox(event, '${newId}'); event.stopPropagation();`);
                            galleryItem.querySelector('.selection-checkmark').setAttribute('onclick', `toggleSelection(event, '${newId}', this.closest('.gallery-item'))`);
                            galleryItem.querySelector('.favorite-btn').setAttribute('onclick', `toggleFavorite(event, '${newId}', this)`);
                            galleryItem.querySelector('.delete-btn').setAttribute('onclick', `deleteFile(event, '${newId}', this)`);
                            galleryItem.querySelector('a[title="Download"]').href = `/galleryout/download/${newId}`;
                        }

                        // 3. If lightbox is open for this file, refresh links
                        if (currentLightboxFile && currentLightboxFile.id === newId) {
                            showItemAtIndex(currentLightboxIndex);
                        }

                    } else {
                        throw new Error(data.message || 'Failed to rename file.');
                    }
                })
                .catch(error => {
                    showNotification(error.message, 'error');
                });
        }

        function renameFileFromLightbox() {
            if (!currentLightboxFile) return;
            renameFile(currentLightboxFile.id, currentLightboxFile.name);
        }

        const summaryOverlay = document.getElementById('node-summary-overlay'); const summaryContent = document.getElementById('node-summary-content');
        function escapeHTML(value) { if (value === null || typeof value === 'undefined') { return '<em>null</em>'; } if (typeof value === 'object') { try { const jsonString = JSON.stringify(value, null, 2); return jsonString.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[m]); } catch (e) { return '[Unserializable Object]'; } } return value.toString().replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '&quot;': '&quot;', "'": '&#39;' })[m]); }
async function showNodeSummary(event, fileId) {
            event.stopPropagation();
            const summaryContent = document.getElementById('node-summary-content');
            const summaryOverlay = document.getElementById('node-summary-overlay');
            
            summaryContent.innerHTML = '<div class="loader" style="margin:2rem auto;"></div>';
            document.body.classList.add('modal-open');
            summaryOverlay.classList.add('visible');

            try {
                const response = await fetch(`/galleryout/node_summary/${fileId}`);
                const data = await response.json();

                if (data.status === 'success' && data.summary) {
                    if (data.summary.length > 0) {
                        let contentHTML = '';
                        let mediaCardsHTML = ''; 

                        data.summary.forEach(node => {
                            let paramsHTML = '<ul class="summary-node-params">';
                            
                            if (node.params && node.params.length > 0) {
                                node.params.forEach(p => {
                                    // 1. Shows parameter in textual list
                                    paramsHTML += `<li><strong>${escapeHTML(p.name)}:</strong> <code>${escapeHTML(p.value)}</code>`;
                                    
                                    // 2. If it is a input file, add link inside the textual list
                                    if (p.is_input_file) {
                                        paramsHTML += ` <span style="color:var(--success-color); font-size:0.8rem;">(Found in Inputs)</span>`;
                                        
                                        // 3. Generate multimedial "Card" 
                                        const fileExt = p.value.toString().split('.').pop().toLowerCase();
                                        
                                        // Definisci il tipo di media
                                        const isVideo = ['mp4', 'mov', 'webm', 'mkv', 'avi'].includes(fileExt);
                                        const isAudio = ['mp3', 'wav', 'ogg', 'flac', 'm4a', 'aac'].includes(fileExt);
                                        
                                        let mediaTag = '';
                                        
                                        if (isAudio) {
                                            mediaTag = `<div style="height:200px; display:flex; align-items:center; justify-content:center; width:100%; background:rgba(0,0,0,0.2); border-radius:8px; margin-bottom:1rem; flex-direction:column; gap:10px;">
                                                <span style="font-size:3rem;">🎵</span>
                                                <audio controls src="${p.input_url}" style="width:90%;"></audio>
                                            </div>`;
                                        } else if (isVideo) {
                                            mediaTag = `<video src="${p.input_url}" controls class="input-media-preview"></video>`;
                                        } else {
                                            // Immagini (incluso jfif)
                                            mediaTag = `<img src="${p.input_url}" class="input-media-preview">`;
                                        }

                                        mediaCardsHTML += `
                                            <div class="input-media-card">
                                                <div class="input-media-title">📥 ${escapeHTML(p.value)}</div>
                                                ${mediaTag}
                                                <div class="input-media-actions">
                                                    <a href="${p.input_url}" download class="input-media-btn">
                                                        💾 Download
                                                    </a>
                                                    <a href="${p.input_url}" target="_blank" class="input-media-btn secondary">
                                                        ↗️ Open Tab
                                                    </a>
                                                </div>
                                            </div>`;
                                    }
                                    paramsHTML += `</li>`;
                                });
                            } else {
                                paramsHTML += `<li>No parameters</li>`;
                            }
                            paramsHTML += '</ul>';

                            contentHTML += `<div class="summary-node-item">
                                <div class="summary-node-header" style="background-color:${node.color};">
                                    ${escapeHTML(node.type)} <small>(ID: ${node.id})</small>
                                </div>
                                ${paramsHTML}
                            </div>`;
                        });
                        
                        let finalInputsSection = '';
                        if (mediaCardsHTML) {
                            finalInputsSection = `
                                <h3 style="margin-top:0; border-bottom:1px solid var(--border-color); padding-bottom:10px;">
                                    🎨 Source Media (Inputs)
                                </h3>
                                <div class="input-media-grid">
                                    ${mediaCardsHTML}
                                </div>
                                <hr style="border:0; border-top:1px solid var(--border-color); margin: 2rem 0;">
                            `;
                        }

                        summaryContent.innerHTML = finalInputsSection + contentHTML;
                    } else {
                        summaryContent.innerHTML = '<p>No active nodes found in this workflow.</p>';
                    }
                } else {
                    summaryContent.innerHTML = `<p style="color:var(--danger-color);">Error: ${data.message || 'Could not load summary.'}</p>`;
                }
            } catch (error) {
                console.error(error);
                summaryContent.innerHTML = `<p style="color:var(--danger-color);">A network error occurred.</p>`;
            }
        }
        function closeNodeSummary() { document.body.classList.remove('modal-open'); summaryOverlay.classList.remove('visible'); summaryContent.innerHTML = ''; }

        // --- WORKFLOW COMPARISON FUNCTIONS ---
        const compareOverlay = document.getElementById('compare-overlay');
        const compareContent = document.getElementById('compare-content');

        async function showCompare() {
            const fileIds = Array.from(selectedFiles);
            if (fileIds.length < 2) {
                showNotification('Please select at least 2 files to compare.', 'warning');
                return;
            }

            compareContent.innerHTML = '<div class="loader" style="margin:2rem auto;"></div>';
            document.body.classList.add('modal-open');
            compareOverlay.classList.add('visible');

            try {
                const response = await fetch('/galleryout/compare_workflows', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ file_ids: fileIds })
                });
                const data = await response.json();

                if (data.status === 'success') {
                    renderComparison(data.files);
                } else {
                    compareContent.innerHTML = `<p style="color:var(--danger-color);">Error: ${data.message || 'Could not load comparison.'}</p>`;
                }
            } catch (error) {
                console.error(error);
                compareContent.innerHTML = `<p style="color:var(--danger-color);">A network error occurred.</p>`;
            }
        }

        function renderComparison(files) {
            // Build a map of all node types across all files with their data
            const allNodeTypes = new Map(); // nodeType -> Map<fileIndex, nodeData>

            files.forEach((file, fileIndex) => {
                if (file.summary) {
                    file.summary.forEach(node => {
                        const key = node.type;
                        if (!allNodeTypes.has(key)) {
                            allNodeTypes.set(key, new Map());
                        }
                        allNodeTypes.get(key).set(fileIndex, node);
                    });
                }
            });

            // Build param comparison data: for each node type, compare params across files
            const paramDiffs = new Map(); // nodeType -> paramName -> Set of unique values

            allNodeTypes.forEach((fileNodes, nodeType) => {
                const paramValues = new Map(); // paramName -> [values per file]
                fileNodes.forEach((node, fileIndex) => {
                    if (node.params) {
                        node.params.forEach(p => {
                            if (!paramValues.has(p.name)) {
                                paramValues.set(p.name, new Array(files.length).fill(undefined));
                            }
                            paramValues.get(p.name)[fileIndex] = p.value;
                        });
                    }
                });
                paramDiffs.set(nodeType, paramValues);
            });

            // Render columns
            let columnsHTML = '';
            files.forEach((file, fileIndex) => {
                const headerClass = file.has_workflow ? '' : 'no-workflow';
                let columnContent = '';

                if (!file.has_workflow) {
                    columnContent = '<p style="padding:1rem;color:var(--text-muted);">No workflow found</p>';
                } else {
                    // Sort node types by category order for consistency
                    const categoryOrder = ['input', 'model', 'processing', 'output', 'others'];
                    const sortedNodeTypes = Array.from(allNodeTypes.keys()).sort((a, b) => {
                        const nodeA = allNodeTypes.get(a).values().next().value;
                        const nodeB = allNodeTypes.get(b).values().next().value;
                        const catA = nodeA ? categoryOrder.indexOf(nodeA.category || 'others') : 4;
                        const catB = nodeB ? categoryOrder.indexOf(nodeB.category || 'others') : 4;
                        return catA - catB;
                    });

                    sortedNodeTypes.forEach(nodeType => {
                        const fileNodes = allNodeTypes.get(nodeType);
                        const node = fileNodes.get(fileIndex);
                        const paramComparison = paramDiffs.get(nodeType);

                        if (node) {
                            let paramsHTML = '<ul class="compare-node-params">';
                            if (node.params && node.params.length > 0) {
                                node.params.forEach(p => {
                                    // Check if this param differs across files
                                    const allValues = paramComparison.get(p.name);
                                    const definedValues = allValues ? allValues.filter(v => v !== undefined) : [];
                                    const uniqueValues = new Set(definedValues.map(v => JSON.stringify(v)));

                                    let diffClass = '';
                                    if (uniqueValues.size > 1) {
                                        diffClass = 'param-different';
                                    } else if (definedValues.length < files.length) {
                                        diffClass = 'param-unique';
                                    }

                                    paramsHTML += `<li class="${diffClass}"><strong>${escapeHTML(p.name)}:</strong> <code>${escapeHTML(p.value)}</code></li>`;
                                });
                            } else {
                                paramsHTML += '<li>No parameters</li>';
                            }
                            paramsHTML += '</ul>';

                            columnContent += `<div class="compare-node-item">
                                <div class="compare-node-header" style="background-color:${node.color};">
                                    ${escapeHTML(node.type)} <small>(ID: ${node.id})</small>
                                </div>
                                ${paramsHTML}
                            </div>`;
                        } else {
                            // Node missing from this file
                            const exampleNode = fileNodes.values().next().value;
                            columnContent += `<div class="compare-node-item node-missing">
                                <div class="compare-node-header" style="background-color:${exampleNode.color};">
                                    ${escapeHTML(nodeType)} <small>(missing)</small>
                                </div>
                                <ul class="compare-node-params"><li>Node not present in this file</li></ul>
                            </div>`;
                        }
                    });
                }

                columnsHTML += `<div class="compare-column">
                    <div class="compare-column-header ${headerClass}" title="${escapeHTML(file.name)}">
                        ${escapeHTML(file.name)}
                    </div>
                    <div class="compare-column-content">
                        ${columnContent}
                    </div>
                </div>`;
            });

            compareContent.innerHTML = columnsHTML;
        }

        function closeCompare() {
            document.body.classList.remove('modal-open');
            compareOverlay.classList.remove('visible');
            compareContent.innerHTML = '';
        }

        // Close compare overlay on click outside or Escape key
        compareOverlay.addEventListener('click', (e) => {
            if (e.target === compareOverlay) closeCompare();
        });

        const uploadOverlay = document.getElementById('upload-overlay'); const showUploadModalBtn = document.getElementById('show-upload-modal-btn'); const uploadCancelBtn = document.getElementById('upload-cancel-btn'); const uploadSubmitBtn = document.getElementById('upload-submit-btn'); const dropZone = document.getElementById('drop-zone'); const fileInput = document.getElementById('upload-file-input'); const folderInput = document.getElementById('upload-folder-input'); const fileBrowseBtn = document.getElementById('file-upload-btn'); const folderBrowseBtn = document.getElementById('folder-upload-btn'); const fileList = document.getElementById('file-list'); const uploadProgressContainer = document.getElementById('upload-progress-container'); const uploadProgressFill = document.getElementById('upload-progress-fill'); const uploadDestinationText = document.getElementById('upload-destination-text').querySelector('strong'); let filesToUpload = []; // Array of {file: File, relativePath: string}
        function resetUploadModal() { filesToUpload = []; fileList.innerHTML = ''; uploadProgressContainer.style.display = 'none'; uploadProgressFill.style.width = '0%'; fileInput.value = ''; folderInput.value = ''; uploadSubmitBtn.disabled = false; }
        function showUploadModal() { resetUploadModal(); uploadDestinationText.textContent = currentFolderInfo.display_name; document.body.classList.add('modal-open'); uploadOverlay.classList.add('visible'); }
        function closeUploadModal() { document.body.classList.remove('modal-open'); uploadOverlay.classList.remove('visible'); }
        function handleFiles(files, isFolder = false) {
            Array.from(files).forEach(file => {
                // Get the relative path for folder uploads
                const relativePath = isFolder ? (file.webkitRelativePath || file.name) : '';
                filesToUpload.push({ file: file, relativePath: relativePath });
            });
            renderFileList();
        }
        function renderFileList() {
            fileList.innerHTML = '';
            // Group files by folder for display
            const folderGroups = {};
            filesToUpload.forEach(({file, relativePath}) => {
                if (relativePath && relativePath.includes('/')) {
                    const folderName = relativePath.split('/')[0];
                    if (!folderGroups[folderName]) folderGroups[folderName] = [];
                    folderGroups[folderName].push({file, relativePath});
                } else {
                    if (!folderGroups['_root']) folderGroups['_root'] = [];
                    folderGroups['_root'].push({file, relativePath});
                }
            });
            // Render folders first
            Object.keys(folderGroups).forEach(folder => {
                if (folder === '_root') return;
                const li = document.createElement('li');
                const totalSize = folderGroups[folder].reduce((acc, f) => acc + f.file.size, 0);
                const sizeKB = (totalSize / 1024).toFixed(1);
                li.innerHTML = `<span>📁 ${folder}/ (${folderGroups[folder].length} files)</span> <span class="file-size">${sizeKB} KB</span>`;
                li.style.fontWeight = '600';
                fileList.appendChild(li);
            });
            // Render root files
            if (folderGroups['_root']) {
                folderGroups['_root'].forEach(({file}) => {
                    const li = document.createElement('li');
                    const sizeKB = (file.size / 1024).toFixed(1);
                    const icon = file.name.toLowerCase().endsWith('.zip') ? '📦' : '📄';
                    li.innerHTML = `<span>${icon} ${file.name}</span> <span class="file-size">${sizeKB} KB</span>`;
                    fileList.appendChild(li);
                });
            }
        }
        function performUpload() {
            if (filesToUpload.length === 0) { showNotification('Please select files to upload.', 'warning'); return; }
            const formData = new FormData();
            formData.append('folder_key', currentFolderKey);
            filesToUpload.forEach(({file, relativePath}) => {
                formData.append('files', file);
                formData.append('relativePaths', relativePath);
            });
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/galleryout/upload', true);
            uploadProgressContainer.style.display = 'block';
            uploadSubmitBtn.disabled = true;
            uploadSubmitBtn.textContent = 'Uploading...';
            xhr.upload.onprogress = function (event) {
                if (event.lengthComputable) {
                    const percentComplete = (event.loaded / event.total) * 100;
                    uploadProgressFill.style.width = percentComplete + '%';
                }
            };
            xhr.onload = function () {
                if (xhr.status >= 200 && xhr.status < 300) {
                    const response = JSON.parse(xhr.responseText);
                    let msg = response.message || 'Upload successful!';
                    if (response.created_folders && response.created_folders.length > 0) {
                        msg += ` Created ${response.created_folders.length} folder(s).`;
                    }
                    showNotification(msg, 'success');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        showNotification(`Upload failed: ${response.message}`, 'error');
                    } catch (e) {
                        showNotification(`Upload failed with status: ${xhr.status}`, 'error');
                    }
                    uploadSubmitBtn.disabled = false;
                    uploadSubmitBtn.textContent = 'Upload';
                }
            };
            xhr.onerror = function () {
                showNotification('An error occurred during the upload.', 'error');
                uploadSubmitBtn.disabled = false;
                uploadSubmitBtn.textContent = 'Upload';
            };
            xhr.send(formData);
        }
        folderBrowseBtn.addEventListener('click', () => folderInput.click());
        folderInput.addEventListener('change', (e) => handleFiles(e.target.files, true));
        function scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); }

        // --- RESCAN FOLDER LOGIC ---
        const rescanModalOverlay = document.getElementById('rescan-modal-overlay');
        const rescanRecentBtn = document.getElementById('rescan-recent-btn');
        const rescanAllBtn = document.getElementById('rescan-all-btn');
        const rescanCancelBtn = document.getElementById('rescan-cancel-btn');

        function showRescanModal() {
            rescanModalOverlay.style.opacity = '1';
            rescanModalOverlay.style.pointerEvents = 'auto';
        }

        function hideRescanModal() {
            rescanModalOverlay.style.opacity = '0';
            rescanModalOverlay.style.pointerEvents = 'none';
        }

        function performRescan(mode) {
            hideRescanModal();
            showNotification('Starting rescan...', 'info');

            // Show sync overlay
            const syncOverlay = document.getElementById('sync-overlay');
            const syncMessage = document.getElementById('sync-message');
            const syncProgressFill = document.getElementById('sync-progress-fill');
            syncOverlay.style.display = 'flex';
            syncMessage.textContent = 'Rescanning files...';
            syncProgressFill.style.width = '100%';
            syncProgressFill.style.backgroundColor = 'var(--primary-color)';
            syncProgressFill.classList.add('indeterminate'); // You might want to add CSS animation for this

            fetch('/galleryout/rescan_folder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ folder_key: currentFolderKey, mode: mode })
            })
                .then(handleGenericResponse)
                .catch(error => {
                    handleError(error);
                    syncOverlay.style.display = 'none';
                });
        }

        // --- MAIN INITIALIZATION FUNCTION ---
        document.addEventListener('DOMContentLoaded', () => {
            loaderOverlay.style.opacity = '0';
            setTimeout(() => { loaderOverlay.style.display = 'none'; }, 400);

            setupFolderControls('nav', 'folder-tree-nav');
            setupFolderControls('move', 'move-folder-tree');
            renderAllTrees();
            setupSidebarExpansion();
            appendFiles(initialFiles);

            new TomSelect('#extension-select', { plugins: ['checkbox_options', 'clear_button'], placeholder: '📄 Select extensions...' });
            new TomSelect('#prefix-select', { plugins: ['checkbox_options', 'clear_button'], placeholder: '🏷️ Select prefixes...' });

            // View size slider functionality
            const viewSizeSlider = document.getElementById('view-size-slider');
            const savedViewSize = localStorage.getItem('galleryViewSize');
            if (savedViewSize) {
                document.documentElement.style.setProperty('--gallery-column-size', savedViewSize + 'px');
                viewSizeSlider.value = savedViewSize;
            }
            viewSizeSlider.addEventListener('input', (e) => {
                const size = e.target.value;
                document.documentElement.style.setProperty('--gallery-column-size', size + 'px');
                localStorage.setItem('galleryViewSize', size);
            });

            const sidebar = document.querySelector('.sidebar');
            const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
            const sidebarToggleText = document.getElementById('sidebar-toggle-text');
            const galleryAnchor = document.getElementById('gallery-anchor');
            const isMobile = window.innerWidth <= 1024;
            if (sidebar && sidebarToggleBtn && isMobile) {
                sidebar.classList.add('nav-collapsed');
                sidebarToggleText.textContent = 'Show Folders';
                sidebarToggleBtn.addEventListener('click', () => {
                    sidebar.classList.toggle('nav-collapsed');
                    sidebarToggleText.textContent = sidebar.classList.contains('nav-collapsed') ? 'Show Folders' : 'Hide Folders';
                });
            }
            if (isMobile && sessionStorage.getItem('galleryMobileNav') === 'true' && galleryAnchor) {
                setTimeout(() => galleryAnchor.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
                sessionStorage.removeItem('galleryMobileNav');
            }
            const mobileFilterToggle = document.getElementById('mobile-filter-toggle');
            const filterFormGrid = document.getElementById('filter-form-grid');
            if (mobileFilterToggle) { mobileFilterToggle.addEventListener('click', () => { filterFormGrid.classList.toggle('visible'); mobileFilterToggle.textContent = filterFormGrid.classList.contains('visible') ? '✕  Hide Filters' : '⚙️ Filters & Options'; }); }

            document.getElementById('folder-tree-nav').addEventListener('click', (e) => {
                const link = e.target.closest('.navigation-link');
                const toggle = e.target.closest('.toggle-btn');
                const actionBtn = e.target.closest('.folder-action-btn');

                if (toggle) {
                    const li = toggle.closest('li');
                    const key = li.dataset.folderKey;
                    const isNowCollapsed = li.classList.toggle('collapsed');
                    if (isNowCollapsed) {
                        expandedFolderKeys.delete(key);
                    } else {
                        expandedFolderKeys.add(key);
                    }
                    localStorage.setItem('galleryFolderState', JSON.stringify([...expandedFolderKeys]));

                } else if (actionBtn) {
                    const li = actionBtn.closest('li');
                    const key = li.dataset.folderKey;
                    const name = actionBtn.dataset.name;
                    if (actionBtn.dataset.action === 'rename') renameFolder(e, key, name);
                    if (actionBtn.dataset.action === 'delete') deleteFolder(e, key, name);

                } else if (link) {
                    window.location.href = link.dataset.folderUrl;
                }
            });

            document.getElementById('move-folder-tree').addEventListener('click', (e) => {
                const toggle = e.target.closest('.toggle-btn');
                const moveBtn = e.target.closest('.move-here-btn');

                if (toggle) {
                    const li = toggle.closest('li');
                    const key = li.dataset.folderKey;
                    const isNowCollapsed = li.classList.toggle('collapsed');
                    if (isNowCollapsed) {
                        expandedFolderKeys.delete(key);
                    } else {
                        expandedFolderKeys.add(key);
                    }
                    localStorage.setItem('galleryFolderState', JSON.stringify([...expandedFolderKeys]));
                }

                if (moveBtn) {
                    confirmMoveToFolder(moveBtn.dataset.folderKey);
                }
            });

            document.getElementById('refresh-btn').addEventListener('click', (e) => { e.preventDefault(); startSyncProcess(true); });
            document.getElementById('rescan-folder-btn').addEventListener('click', showRescanModal);
            rescanRecentBtn.addEventListener('click', () => performRescan('recent'));
            rescanAllBtn.addEventListener('click', () => performRescan('all'));
            rescanCancelBtn.addEventListener('click', hideRescanModal);
            document.getElementById('main-select-all-btn').addEventListener('click', selectAll);
            document.getElementById('create-folder-btn').addEventListener('click', createFolder);
            document.getElementById('cancel-drop-btn').addEventListener('click', hideDropZone);
            document.getElementById('select-all-btn').addEventListener('click', selectAll);
            document.getElementById('deselect-all-btn').addEventListener('click', deselectAll);
            document.getElementById('move-selected-btn').addEventListener('click', moveSelected);
            document.getElementById('download-zip-btn').addEventListener('click', downloadSelectedZip);
            document.getElementById('delete-selected-btn').addEventListener('click', deleteSelected);
            document.getElementById('favorite-selected-btn').addEventListener('click', () => favoriteSelected(true));
            document.getElementById('unfavorite-selected-btn').addEventListener('click', () => favoriteSelected(false));
            document.getElementById('compare-btn').addEventListener('click', showCompare);
            document.querySelector('#lightbox-overlay .close-btn').addEventListener('click', closeLightbox);
            document.getElementById('lightbox-prev').addEventListener('click', () => navigateLightbox(-1));
            document.getElementById('lightbox-next').addEventListener('click', () => navigateLightbox(1));
            document.getElementById('lightbox-zoom-in').addEventListener('click', () => zoomLightbox(0.2));
            document.getElementById('lightbox-zoom-out').addEventListener('click', () => zoomLightbox(-0.2));

            // --- PLAYBACK SPEED CONTROL ---
            const speedSlider = document.getElementById('speed-slider');
            const speedValue = document.getElementById('speed-value');
            const speedReset = document.getElementById('speed-reset');
            const speedControl = document.getElementById('speed-control');

            // Load saved speed from localStorage
            let savedSpeed = parseFloat(localStorage.getItem('videoPlaybackSpeed')) || 1;
            speedSlider.value = savedSpeed;
            speedValue.textContent = savedSpeed + 'x';

            speedSlider.addEventListener('input', () => {
                const speed = parseFloat(speedSlider.value);
                speedValue.textContent = speed + 'x';
                localStorage.setItem('videoPlaybackSpeed', speed);
                applyVideoSpeed(speed);
            });

            speedReset.addEventListener('click', () => {
                speedSlider.value = 1;
                speedValue.textContent = '1x';
                localStorage.setItem('videoPlaybackSpeed', 1);
                applyVideoSpeed(1);
            });

            document.getElementById('lightbox-delete-btn').addEventListener('click', () => deleteFromLightbox(false));
            // --- MODIFICATION: Add event listener for the new rename button ---
            document.getElementById('lightbox-rename-btn').addEventListener('click', renameFileFromLightbox);

            document.getElementById('lightbox-content').addEventListener('wheel', (event) => { if (lightboxOverlay.classList.contains('visible')) { event.preventDefault(); zoomLightbox(event.deltaY < 0 ? 0.1 : -0.1); } });
            document.getElementById('close-summary-btn').addEventListener('click', closeNodeSummary);
            summaryOverlay.addEventListener('click', (event) => { if (event.target === summaryOverlay) closeNodeSummary(); });
            showUploadModalBtn.addEventListener('click', showUploadModal);
            uploadCancelBtn.addEventListener('click', closeUploadModal);
            uploadOverlay.addEventListener('click', (event) => { if (event.target === uploadOverlay) closeUploadModal(); });
            fileBrowseBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', () => handleFiles(fileInput.files));

            // --- KEYBOARD SHORTCUTS ---
            document.addEventListener('keydown', (e) => {
                // Ignore shortcuts if user is typing in an input
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) return;

                // 1. GESTIONE CTRL+A (Manteniamo la tua funzione originale)
                if ((e.ctrlKey || e.metaKey) && (e.key === 'a' || e.key === 'A')) {
                    e.preventDefault();
                    selectAll();
                    return;
                }

                // 2. GESTIONE ESCAPE (Unificata qui per pulizia)
                if (e.key === 'Escape') {
                    const shortcutsHelp = document.getElementById('shortcuts-help-overlay');
                    if (shortcutsHelp.classList.contains('visible')) {
                        closeShortcutsHelp();
                        return;
                    }
                    if (uploadOverlay.classList.contains('visible')) {
                        closeUploadModal();
                        return;
                    }
                    if (summaryOverlay.classList.contains('visible')) {
                        closeNodeSummary();
                        return;
                    }
                    if (compareOverlay.classList.contains('visible')) {
                        closeCompare();
                        return;
                    }
                    // Se c'è una selezione e nessun modale, deseleziona tutto
                    if (selectedFiles.size > 0 && !document.body.classList.contains('lightbox-open')) {
                         deselectAll();
                    }
                    hideDropZone();
                    // Nota: L'escape della Lightbox è gestito nel blocco isLightboxOpen sotto
                }

                if (document.body.classList.contains('modal-open')) return;

                const isLightboxOpen = document.body.classList.contains('lightbox-open');
                
                if (isLightboxOpen) {
                    switch (e.key) {
                        case 'ArrowLeft':
                            navigateLightbox(-1);
                            break;
                        case 'ArrowRight':
                            navigateLightbox(1);
                            break;
                        case 'v':
                        case 'V':
                        case 'Escape':
                            closeLightbox();
                            break;
                        case 'd':
                        case 'D':
                        case 'Delete':
                             deleteFromLightbox(true); // true = no confirmation
                            break;
                        case 'f':
                        case 'F':
                            if (currentLightboxFile) {
                                const item = galleryItems[currentLightboxIndex];
                                if (item) {
                                    const favBtn = item.querySelector('.favorite-btn');
                                    if (favBtn) toggleFavorite(e, currentLightboxFile.id, favBtn);
                                }
                            }
                            break;
                        case 's':
                        case 'S':
                            if (currentLightboxFile) {
                                const link = document.createElement('a');
                                link.href = `/galleryout/download/${currentLightboxFile.id}`;
                                link.download = '';
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                            }
                            break;
                        case 'r':
                        case 'R':
                            renameFileFromLightbox();
                            break;
                        case 't':
                        case 'T':
                            if (currentLightboxFile && socialEnabled) {
                                openTagsPanel(currentLightboxFile.id);
                            }
                            break;
                        case 'p':
                        case 'P':
                            if (currentLightboxFile && socialEnabled) {
                                postFromLightbox(currentLightboxFile.id);
                            }
                            break;
                        case 'o':
                        case 'O':
                            if (currentLightboxFile) {
                                window.open(`/galleryout/file/${currentLightboxFile.id}`, '_blank');
                            }
                            break;
                        case '+':
                        case '=':
                            zoomLightbox(0.1);
                            break;
                        case '-':
                        case '_':
                            zoomLightbox(-0.1);
                            break;
                        case '0':
                            currentZoom = 1;
                            currentTranslateX = 0;
                            currentTranslateY = 0;
                            updateMediaTransform();
                            break;
                        case '.':
                            cyclePanStep();
                            break;
                        // Numpad support
                        case '8': // Up
                            panLightbox(0, panStep);
                            break;
                        case '2': // Down
                            panLightbox(0, -panStep);
                            break;
                        case '4': // Left
                            panLightbox(panStep, 0);
                            break;
                        case '6': // Right
                            panLightbox(-panStep, 0);
                            break;
                        case '7': // Up-Left
                            panLightbox(panStep, panStep);
                            break;
                        case '9': // Up-Right
                            panLightbox(-panStep, panStep);
                            break;
                        case '1': // Down-Left
                            panLightbox(panStep, -panStep);
                            break;
                        case '3': // Down-Right
                            panLightbox(-panStep, -panStep);
                            break;
                        case 'h':
                        case 'H':
                            hideToolbarTemporary();
                            break;
                        case '?':
                            showShortcutsHelp();
                            break;
                    }
                } else {
                    // Main View Shortcuts
                    if (e.key === 'z' || e.key === 'Z') {
                        downloadSelectedZip();
                    }
                    if (e.key === 'l' || e.key === 'L') {
                        startSyncProcess(true);
                    }

                    if (e.key === 'k' || e.key === 'K') {
                        showRescanModal();
                    }
                    if (e.key === '?') {
                        showShortcutsHelp();
                        return;
                    }

                    if (galleryItems.length === 0) return;

                    // Calculate columns for Up/Down navigation
                    const getColumns = () => {
                        const gridStyle = window.getComputedStyle(galleryContainer);
                        const gridTemplateColumns = gridStyle.getPropertyValue('grid-template-columns');
                        return gridTemplateColumns.split(' ').length;
                    };

                    switch (e.key) {
                        case 'ArrowRight':
                            e.preventDefault();
                            updateFocus(1);
                            break;
                        case 'ArrowLeft':
                            e.preventDefault();
                            updateFocus(-1);
                            break;
                        case 'ArrowDown':
                            e.preventDefault();
                            updateFocus(getColumns());
                            break;
                        case 'ArrowUp':
                            e.preventDefault();
                            updateFocus(-getColumns());
                            break;
                        case 'v':
                        case 'V':
                            if (focusedItemIndex !== -1) {
                                const item = galleryItems[focusedItemIndex];
                                openLightbox(e, item.dataset.fileId);
                            }
                            break;
                        case 'd':
                        case 'D':
                            if (selectedFiles.size > 0) {
                                deleteSelected();
                            } else if (focusedItemIndex !== -1) {
                                const item = galleryItems[focusedItemIndex];
                                deleteFile(e, item.dataset.fileId, item.querySelector('.delete-btn'));
                            }
                            break;
                        case 'f':
                        case 'F':
                            if (focusedItemIndex !== -1) {
                                const item = galleryItems[focusedItemIndex];
                                const favBtn = item.querySelector('.favorite-btn');
                                if (favBtn) toggleFavorite(e, item.dataset.fileId, favBtn);
                            }
                            break;
                        case 'x':
                        case 'X':
                            if (focusedItemIndex !== -1) {
                                const item = galleryItems[focusedItemIndex];
                                toggleSelection(e, item.dataset.fileId, item);
                            }
                            break;
                        case 's':
                        case 'S':
                            if (focusedItemIndex !== -1) {
                                const item = galleryItems[focusedItemIndex];
                                const fileId = item.dataset.fileId;
                                const link = document.createElement('a');
                                link.href = `/galleryout/download/${fileId}`;
                                link.download = '';
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                            }
                            break;
                        case 'r':
                        case 'R':
                            if (focusedItemIndex !== -1) {
                                const item = galleryItems[focusedItemIndex];
                                const fileId = item.dataset.fileId;
                                const file = allFilesData.find(f => f.id === fileId);
                                if (file) renameFile(fileId, file.name);
                            }
                            break;
                        case 'm':
                        case 'M':
                            moveSelected();
                            break;
                    }
                }
            });

            function updateFocus(delta) {
                if (galleryItems.length === 0) return;

                let newIndex = focusedItemIndex + delta;

                // Clamp index
                if (newIndex < 0) newIndex = 0;
                if (newIndex >= galleryItems.length) newIndex = galleryItems.length - 1;

                if (newIndex !== focusedItemIndex) {
                    if (focusedItemIndex !== -1 && galleryItems[focusedItemIndex]) {
                        galleryItems[focusedItemIndex].classList.remove('focused');
                    }
                    focusedItemIndex = newIndex;
                    const newItem = galleryItems[focusedItemIndex];
                    newItem.classList.add('focused');
                    newItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else if (focusedItemIndex === -1) {
                    // Initialize focus if none
                    focusedItemIndex = 0;
                    galleryItems[0].classList.add('focused');
                }
            }
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
            dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
            uploadSubmitBtn.addEventListener('click', performUpload);
            const loadMoreBtn = document.getElementById('load-more-btn');
            if (loadMoreBtn) { loadMoreBtn.addEventListener('click', async function () { this.disabled = true; this.innerHTML = '📂 Loading...'; try { const response = await fetch(`/galleryout/load_more?offset=${currentItemCount}&folder_key=${currentFolderKey}&${new URLSearchParams(new FormData(document.querySelector('.filter-bar form')))}`); const data = await response.json(); if (data.files && data.files.length > 0) appendFiles(data.files); else { showNotification('No more files to load.', 'info'); this.style.display = 'none'; } } catch (error) { handleError(error); } if (currentItemCount < totalFiles) { this.disabled = false; this.innerHTML = '📂 Load More'; } }); }

            function showShortcutsHelp() { document.getElementById('shortcuts-help-overlay').classList.add('visible'); }
            function closeShortcutsHelp() { document.getElementById('shortcuts-help-overlay').classList.remove('visible'); }
            document.getElementById('shortcuts-help-overlay').addEventListener('click', (e) => { if (e.target.id === 'shortcuts-help-overlay') closeShortcutsHelp(); });
            const closeShortcutsBtn = document.getElementById('close-shortcuts-btn');
            if (closeShortcutsBtn) {
                closeShortcutsBtn.addEventListener('click', closeShortcutsHelp);
            }
            window.onscroll = () => { if (backToTopBtn) { backToTopBtn.style.display = (window.scrollY > 300) ? 'block' : 'none'; } };

            startSyncProcess(false);
        });
    </script>
</body>

</html>