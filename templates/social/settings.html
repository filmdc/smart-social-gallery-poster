<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ branding.site_name }} - Social Settings</title>
    <style>
        :root {
            --bg-color: #0a0a0a;
            --surface-color: #1a1a1a;
            --surface-hover: #252525;
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --text-color: #f8f9fa;
            --text-muted: #adb5bd;
            --border-color: #343a40;
            --danger-color: #dc3545;
            --success-color: #20c997;
            --favorite-color: #ffc107;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.2);
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }
        .top-bar {
            background: var(--surface-color);
            border-bottom: 1px solid var(--glass-border);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .top-bar h1 { font-size: 1.2rem; }
        .top-bar a {
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.9rem;
        }
        .top-bar a:hover { color: var(--text-color); }
        .content {
            max-width: 900px;
            margin: 2rem auto;
            padding: 0 2rem;
        }
        .section {
            background: var(--surface-color);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .section h2 {
            font-size: 1rem;
            margin-bottom: 1rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
            text-decoration: none;
            display: inline-block;
        }
        .btn:hover { opacity: 0.85; }
        .btn-primary { background: var(--gradient-primary); color: white; }
        .btn-secondary { background: var(--surface-hover); color: var(--text-color); border: 1px solid var(--border-color); }
        .btn-danger { background: var(--danger-color); color: white; }
        .btn-sm { padding: 0.3rem 0.7rem; font-size: 0.8rem; }

        /* Account cards */
        .account-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.8rem 1rem;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }
        .account-info {
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }
        .platform-badge {
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .platform-badge.facebook { background: #1877F2; color: white; }
        .platform-badge.instagram { background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); color: white; }
        .platform-badge.linkedin { background: #0A66C2; color: white; }

        .connect-btns {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        .connect-btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            color: white;
        }
        .connect-btn.facebook { background: #1877F2; }
        .connect-btn.instagram { background: linear-gradient(45deg, #f09433, #e6683c, #dc2743); }
        .connect-btn.linkedin { background: #0A66C2; }
        .connect-btn:hover { opacity: 0.85; }
        .connect-btn.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* User table */
        .user-table {
            width: 100%;
            border-collapse: collapse;
        }
        .user-table th, .user-table td {
            text-align: left;
            padding: 0.6rem 0.8rem;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
        }
        .user-table th {
            color: var(--text-muted);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }
        .role-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .role-badge.admin { background: rgba(0,123,255,0.2); color: var(--primary-color); }
        .role-badge.marketing_admin { background: rgba(32,201,151,0.2); color: var(--success-color); }
        .role-badge.employee { background: rgba(173,181,189,0.2); color: var(--text-muted); }

        /* Add user form */
        .add-user-form {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto auto;
            gap: 0.5rem;
            margin-top: 1rem;
            align-items: end;
        }
        @media (max-width: 768px) {
            .add-user-form {
                grid-template-columns: 1fr;
            }
        }
        .add-user-form label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.2rem;
        }
        .add-user-form input, .add-user-form select {
            width: 100%;
            padding: 0.5rem 0.8rem;
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-color);
            font-size: 0.85rem;
            outline: none;
        }
        .add-user-form select {
            appearance: none;
            cursor: pointer;
        }

        .not-configured {
            color: var(--text-muted);
            font-size: 0.8rem;
            font-style: italic;
        }

        .flash-messages { max-width: 900px; margin: 1rem auto; padding: 0 2rem; }
        .flash {
            padding: 0.6rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }
        .flash.success { background: rgba(32, 201, 151, 0.15); border: 1px solid var(--success-color); }
        .flash.error { background: rgba(220, 53, 69, 0.15); border: 1px solid var(--danger-color); }

        /* SharePoint */
        .sp-status-row {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            margin-bottom: 1rem;
        }
        .sp-status {
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .sp-status.connected { background: rgba(32,201,151,0.2); color: var(--success-color); }
        .sp-status.not-configured { background: rgba(173,181,189,0.2); color: var(--text-muted); }
        .sp-config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        @media (max-width: 600px) {
            .sp-config-grid { grid-template-columns: 1fr; }
        }
        .sp-config-item {
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
            padding: 0.5rem 0.7rem;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 6px;
        }
        .sp-config-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.04em; }
        .sp-config-value { font-size: 0.85rem; }
        .sp-config-value.sp-path { font-size: 0.75rem; font-family: monospace; word-break: break-all; }
        .sp-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .sp-result {
            margin-top: 0.8rem;
            padding: 0.6rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
        }
        .sp-result.success { background: rgba(32,201,151,0.12); border: 1px solid var(--success-color); color: var(--success-color); }
        .sp-result.error { background: rgba(220,53,69,0.12); border: 1px solid var(--danger-color); color: var(--danger-color); }
        .sp-result.info { background: rgba(0,123,255,0.12); border: 1px solid var(--primary-color); color: var(--primary-color); }
        .sp-env-list {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }
        .sp-env-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.4rem 0.7rem;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 6px;
            font-size: 0.85rem;
        }
        .sp-env-item code {
            font-size: 0.8rem;
            color: var(--favorite-color);
        }
        .sp-env-item span { color: var(--text-muted); font-size: 0.8rem; }

        /* SharePoint Sync Folders */
        .sp-sync-folders {
            margin-top: 1.2rem;
            border-top: 1px solid var(--glass-border);
            padding-top: 1rem;
        }
        .sp-sync-folders h3 {
            font-size: 0.9rem;
            margin-bottom: 0.8rem;
            color: var(--text-color);
        }
        .sp-folder-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .sp-folder-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.6rem 0.8rem;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
        }
        .sp-folder-info {
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
        }
        .sp-folder-local {
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .sp-folder-local .sp-badge {
            background: #038387;
            color: white;
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 600;
        }
        .sp-folder-remote {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: monospace;
        }
        .sp-folder-meta {
            font-size: 0.7rem;
            color: var(--text-muted);
        }
        .sp-folder-actions {
            display: flex;
            gap: 0.4rem;
        }
        .sp-no-folders {
            color: var(--text-muted);
            font-size: 0.85rem;
            font-style: italic;
            padding: 0.5rem 0;
        }

        /* SharePoint Browser Modal */
        .sp-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .sp-modal-overlay.active { display: flex; }
        .sp-modal {
            background: var(--surface-color);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            width: 90%;
            max-width: 650px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }
        .sp-modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sp-modal-header h3 { margin: 0; font-size: 1.1rem; }
        .sp-modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
        }
        .sp-modal-close:hover { color: var(--text-color); }
        .sp-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 1rem 1.5rem;
            min-height: 300px;
        }
        /* Search bar */
        .sp-search-bar {
            margin-bottom: 1rem;
        }
        .sp-search-bar input {
            width: 100%;
            padding: 0.6rem 1rem;
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-color);
            font-size: 0.9rem;
        }
        .sp-search-bar input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        .sp-search-bar input::placeholder {
            color: var(--text-muted);
        }
        /* Tree view */
        .sp-tree {
            display: flex;
            flex-direction: column;
        }
        .sp-tree-node {
            display: flex;
            flex-direction: column;
        }
        .sp-tree-row {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.4rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.15s;
        }
        .sp-tree-row:hover {
            background: var(--glass-bg);
        }
        .sp-tree-expand {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 3px;
            flex-shrink: 0;
        }
        .sp-tree-expand:hover {
            background: var(--border-color);
        }
        .sp-tree-expand.loading {
            color: var(--primary-color);
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .sp-tree-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: var(--primary-color);
            flex-shrink: 0;
        }
        .sp-tree-icon {
            font-size: 1rem;
            flex-shrink: 0;
        }
        .sp-tree-name {
            flex: 1;
            font-size: 0.9rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .sp-tree-count {
            font-size: 0.75rem;
            color: var(--text-muted);
            flex-shrink: 0;
        }
        .sp-tree-children {
            margin-left: 1.4rem;
            border-left: 1px dashed var(--border-color);
            padding-left: 0.5rem;
        }
        .sp-tree-children.collapsed {
            display: none;
        }
        .sp-tree-row.highlighted {
            background: rgba(59, 130, 246, 0.15);
        }
        /* Selection count */
        .sp-selection-count {
            font-size: 0.85rem;
            color: var(--text-muted);
            padding: 0.5rem 0;
            border-top: 1px solid var(--glass-border);
            margin-top: 0.5rem;
        }
        .sp-selection-count strong {
            color: var(--primary-color);
        }
        .sp-modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--glass-border);
        }
        .sp-add-form {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }
        .sp-add-form label {
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        .sp-add-form input[type="text"] {
            width: 100%;
            padding: 0.5rem 0.8rem;
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-color);
            font-size: 0.9rem;
        }
        .sp-add-form .checkbox-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .sp-add-form .checkbox-row input[type="checkbox"] {
            width: auto;
        }
        .sp-modal-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            margin-top: 1rem;
        }
        .sp-loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }
        .sp-no-results {
            text-align: center;
            padding: 1.5rem;
            color: var(--text-muted);
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <h1>Settings</h1>
        <div>
            <a href="{{ url_for('social.dashboard') }}">Dashboard</a>
            &nbsp;|&nbsp;
            <a href="/galleryout/">Gallery</a>
            &nbsp;|&nbsp;
            <a href="{{ url_for('social.profile') }}">Profile</a>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="flash-messages">
        {% for category, message in messages %}
        <div class="flash {{ category }}">{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <div class="content">
        <!-- Connected Accounts -->
        <div class="section">
            <h2>Connected Accounts</h2>
            {% if accounts %}
                {% for account in accounts %}
                <div class="account-card" id="account-{{ account.id }}">
                    <div class="account-info">
                        <span class="platform-badge {{ account.platform }}">{{ account.platform }}</span>
                        <span>{{ account.account_name }}</span>
                        <span style="color:var(--text-muted);font-size:0.8rem;">
                            ({{ account.account_type }})
                            {% if not account.is_active %} - Disconnected{% endif %}
                        </span>
                    </div>
                    {% if account.is_active %}
                    <button class="btn btn-danger btn-sm" onclick="disconnectAccount('{{ account.id }}')">Disconnect</button>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
            <p style="color:var(--text-muted);font-size:0.9rem;">No accounts connected yet.</p>
            {% endif %}

            <div class="connect-btns">
                {% if fb_available %}
                <a href="{{ url_for('social.oauth_authorize', platform='facebook') }}"
                   class="connect-btn facebook">Connect Facebook &amp; Instagram</a>
                {% else %}
                <span class="connect-btn facebook disabled" title="Set FB_APP_ID and FB_APP_SECRET environment variables">
                    Facebook / Instagram
                </span>
                <span class="not-configured">Set FB_APP_ID + FB_APP_SECRET env vars</span>
                {% endif %}

                {% if li_available %}
                <a href="{{ url_for('social.oauth_authorize', platform='linkedin') }}"
                   class="connect-btn linkedin">Connect LinkedIn</a>
                {% else %}
                <span class="connect-btn linkedin disabled" title="Set LINKEDIN_CLIENT_ID and LINKEDIN_CLIENT_SECRET environment variables">
                    LinkedIn
                </span>
                <span class="not-configured">Set LINKEDIN_CLIENT_ID + LINKEDIN_CLIENT_SECRET env vars</span>
                {% endif %}
            </div>
        </div>

        <!-- SharePoint Integration -->
        <div class="section">
            <h2>SharePoint Integration</h2>

            {% if sp_available %}
            <div class="sp-status-row">
                <span class="sp-status connected">Connected</span>
                <span style="color:var(--text-muted);font-size:0.85rem;">{{ sp_site_url }}</span>
            </div>

            <div class="sp-config-grid">
                <div class="sp-config-item">
                    <span class="sp-config-label">Document Library</span>
                    <span class="sp-config-value">{{ sp_library }}</span>
                </div>
                <div class="sp-config-item">
                    <span class="sp-config-label">Sync Interval</span>
                    <span class="sp-config-value">{{ sp_sync_interval }}s ({{ (sp_sync_interval / 60)|round(0)|int }} min)</span>
                </div>
            </div>

            <div class="sp-actions">
                <button class="btn btn-secondary" id="sp-test-btn" onclick="testSharePoint()">Test Connection</button>
                <button class="btn btn-primary" id="sp-sync-btn" onclick="syncSharePoint()">Sync Now</button>
            </div>
            <div id="sp-result" class="sp-result" style="display:none;"></div>

            <!-- Sync Folders Section -->
            <div class="sp-sync-folders">
                <h3>Synced Folders</h3>
                <p style="color:var(--text-muted);font-size:0.8rem;margin-bottom:0.8rem;">
                    Select folders from SharePoint to sync directly into your gallery.
                </p>
                <div class="sp-folder-list" id="sp-folder-list">
                    <div class="sp-loading">Loading configured folders...</div>
                </div>
                <button class="btn btn-secondary" onclick="openSpFolderBrowser()">+ Add Folder from SharePoint</button>
            </div>

            {% else %}
            <div class="sp-status-row">
                <span class="sp-status not-configured">Not Configured</span>
            </div>
            <p style="color:var(--text-muted);font-size:0.9rem;margin:0.8rem 0 0.5rem;">
                Set these environment variables to connect a SharePoint document library:
            </p>
            <div class="sp-env-list">
                <div class="sp-env-item">
                    <code>SHAREPOINT_TENANT_ID</code>
                    <span>{{ "Set" if sp_has_tenant else "Not set" }}</span>
                </div>
                <div class="sp-env-item">
                    <code>SHAREPOINT_CLIENT_ID</code>
                    <span>{{ "Set" if sp_has_client else "Not set" }}</span>
                </div>
                <div class="sp-env-item">
                    <code>SHAREPOINT_CLIENT_SECRET</code>
                    <span>Required (secret)</span>
                </div>
                <div class="sp-env-item">
                    <code>SHAREPOINT_SITE_URL</code>
                    <span>{{ sp_site_url if sp_site_url else "Not set" }}</span>
                </div>
                <div class="sp-env-item">
                    <code>SHAREPOINT_LIBRARY_NAME</code>
                    <span>{{ sp_library }} (default)</span>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- SharePoint Folder Browser Modal -->
        <div id="sp-folder-modal" class="sp-modal-overlay">
            <div class="sp-modal">
                <div class="sp-modal-header">
                    <h3>Add SharePoint Folders</h3>
                    <button type="button" class="sp-modal-close" onclick="closeSpFolderBrowser()">&times;</button>
                </div>
                <div class="sp-modal-body">
                    <div class="sp-search-bar">
                        <input type="text" id="sp-search-input" placeholder="Search folders..." oninput="filterSpFolders()">
                    </div>
                    <div id="sp-tree-container">
                        <div class="sp-loading" id="sp-tree-loading">Loading folders from SharePoint...</div>
                        <div class="sp-tree" id="sp-tree" style="display:none;"></div>
                        <div class="sp-no-results" id="sp-no-results" style="display:none;">No folders match your search</div>
                    </div>
                    <div class="sp-selection-count" id="sp-selection-count" style="display:none;">
                        <strong id="sp-selected-count">0</strong> folder(s) selected
                    </div>
                </div>
                <div class="sp-modal-footer" id="sp-modal-footer" style="display:none;">
                    <div class="sp-add-form">
                        <div class="checkbox-row">
                            <input type="checkbox" id="sp-include-subfolders" checked>
                            <label for="sp-include-subfolders" style="margin:0;">Include subfolders when syncing</label>
                        </div>
                        <div class="sp-modal-actions">
                            <button class="btn btn-secondary" onclick="closeSpFolderBrowser()">Cancel</button>
                            <button class="btn btn-primary" id="sp-add-btn" onclick="addSelectedSpFolders()">Add Selected Folders</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Email Configuration -->
        <div class="section">
            <h2>Email Configuration</h2>

            {% if email_configured %}
            <div class="sp-status-row">
                <span class="sp-status connected">Configured</span>
                <span style="color:var(--text-muted);font-size:0.85rem;">{{ email_host }}</span>
            </div>

            <div class="sp-config-grid">
                <div class="sp-config-item">
                    <span class="sp-config-label">From Address</span>
                    <span class="sp-config-value">{{ email_from }}</span>
                </div>
                <div class="sp-config-item">
                    <span class="sp-config-label">SMTP Server</span>
                    <span class="sp-config-value">{{ email_host }}</span>
                </div>
            </div>

            <div class="sp-actions">
                <input type="email" id="test-email-address" placeholder="Enter email to test..."
                       style="padding:0.5rem 0.8rem;background:var(--bg-color);border:1px solid var(--border-color);border-radius:6px;color:var(--text-color);font-size:0.85rem;width:250px;">
                <button class="btn btn-secondary" id="email-test-btn" onclick="sendTestEmail()">Send Test Email</button>
            </div>
            <div id="email-result" class="sp-result" style="display:none;"></div>

            {% else %}
            <div class="sp-status-row">
                <span class="sp-status not-configured">Not Configured</span>
            </div>
            <p style="color:var(--text-muted);font-size:0.9rem;margin:0.8rem 0 0.5rem;">
                Set these environment variables to enable email functionality (password resets, notifications):
            </p>
            <div class="sp-env-list">
                <div class="sp-env-item">
                    <code>SMTP_HOST</code>
                    <span>SMTP server address (e.g., smtp.gmail.com)</span>
                </div>
                <div class="sp-env-item">
                    <code>SMTP_PORT</code>
                    <span>SMTP port (default: 587)</span>
                </div>
                <div class="sp-env-item">
                    <code>SMTP_USER</code>
                    <span>SMTP username/email</span>
                </div>
                <div class="sp-env-item">
                    <code>SMTP_PASSWORD</code>
                    <span>SMTP password or app password</span>
                </div>
                <div class="sp-env-item">
                    <code>SMTP_FROM_EMAIL</code>
                    <span>From address (optional, defaults to SMTP_USER)</span>
                </div>
                <div class="sp-env-item">
                    <code>SMTP_FROM_NAME</code>
                    <span>From name (optional, defaults to SITE_NAME)</span>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Categories Management -->
        {% if current_user.can_post_without_approval %}
        <div class="section">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <h2 style="margin-bottom:0;">Programs & Campaigns</h2>
                <a href="{{ url_for('social.categories') }}" class="btn btn-secondary btn-sm">
                    Manage Categories
                </a>
            </div>
            <p style="color:var(--text-muted);font-size:0.85rem;margin-top:0.5rem;">
                Organize media by organizational programs and marketing campaigns.
            </p>
        </div>
        {% endif %}

        <!-- User Management -->
        <div class="section">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
                <h2 style="margin-bottom:0;">User Management</h2>
                <a href="{{ url_for('social.registration_requests') }}" class="btn btn-secondary btn-sm">
                    Pending Requests
                </a>
            </div>
            <table class="user-table">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Display Name</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr id="user-{{ user.id }}">
                        <td>{{ user.username }}</td>
                        <td>{{ user.display_name }}</td>
                        <td>
                            <select onchange="updateUserRole('{{ user.id }}', this.value)"
                                    style="background:var(--bg-color);color:var(--text-color);border:1px solid var(--border-color);border-radius:4px;padding:2px 6px;font-size:0.8rem;">
                                <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>Admin</option>
                                <option value="marketing_admin" {% if user.role == 'marketing_admin' %}selected{% endif %}>Marketing Admin</option>
                                <option value="employee" {% if user.role == 'employee' %}selected{% endif %}>Employee</option>
                            </select>
                        </td>
                        <td>
                            {% if user.is_active %}
                            <span style="color:var(--success-color);font-size:0.85rem;">Active</span>
                            {% else %}
                            <span style="color:var(--danger-color);font-size:0.85rem;">Inactive</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if user.id != current_user.id %}
                            <button class="btn btn-danger btn-sm" onclick="deleteUser('{{ user.id }}', '{{ user.username }}')">Delete</button>
                            {% else %}
                            <span style="color:var(--text-muted);font-size:0.8rem;">(you)</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <form class="add-user-form" onsubmit="return addUser(event)">
                <div>
                    <label>Username</label>
                    <input type="text" id="new-username" required minlength="3" placeholder="username">
                </div>
                <div>
                    <label>Display Name</label>
                    <input type="text" id="new-display-name" placeholder="Display Name">
                </div>
                <div>
                    <label>Password</label>
                    <input type="password" id="new-password" required minlength="8" placeholder="min 8 chars">
                </div>
                <div>
                    <label>Role</label>
                    <select id="new-role">
                        <option value="employee">Employee</option>
                        <option value="marketing_admin">Marketing Admin</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div>
                    <label>&nbsp;</label>
                    <button type="submit" class="btn btn-primary">Add User</button>
                </div>
            </form>
        </div>

        <!-- Storage Management (Admin Only) -->
        <div class="section" id="storage-section">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">
                <h2 style="margin-bottom:0;">Storage Management</h2>
                <div style="display:flex;gap:0.5rem;">
                    <button class="btn btn-secondary btn-sm" onclick="refreshStorageStatus()">Refresh</button>
                    <button class="btn btn-primary btn-sm" onclick="runMaintenance(false)">Run Cleanup</button>
                    <button class="btn btn-danger btn-sm" onclick="runMaintenance(true)" title="Use shorter retention periods for emergency cleanup">Emergency Cleanup</button>
                </div>
            </div>
            <div id="storage-timestamp" style="font-size:0.8rem;color:var(--text-muted);margin-bottom:1rem;font-family:monospace;"></div>

            <!-- Volume Status -->
            <div id="storage-health" style="margin-bottom:1rem;padding:1rem;border-radius:8px;background:var(--glass-bg);border:1px solid var(--glass-border);">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <span id="health-status" style="font-weight:600;">Loading storage status...</span>
                    <span id="health-percent" style="font-size:1.5rem;font-weight:700;"></span>
                </div>
                <div style="margin-top:0.5rem;height:8px;background:var(--bg-color);border-radius:4px;overflow:hidden;">
                    <div id="health-bar" style="height:100%;width:0%;background:var(--success-color);transition:width 0.3s,background 0.3s;"></div>
                </div>
                <div id="health-details" style="margin-top:0.5rem;font-size:0.85rem;color:var(--text-muted);"></div>
                <div id="health-recommendations" style="margin-top:0.5rem;font-size:0.85rem;display:none;"></div>
            </div>

            <!-- Cache Breakdown -->
            <div style="margin-bottom:1rem;">
                <h3 style="font-size:0.9rem;color:var(--text-muted);margin-bottom:0.5rem;">Cache Usage Breakdown</h3>
                <div id="cache-breakdown">
                    <div style="color:var(--text-muted);font-size:0.85rem;">Loading...</div>
                </div>
            </div>

            <!-- Retention Settings Info -->
            <div id="retention-info" style="font-size:0.85rem;color:var(--text-muted);border-top:1px solid var(--glass-border);padding-top:1rem;margin-top:1rem;">
                <strong>Current Retention Settings:</strong>
                <span id="retention-values">Loading...</span>
            </div>

            <!-- Maintenance Result -->
            <div id="maintenance-result" style="display:none;margin-top:1rem;padding:1rem;border-radius:8px;"></div>
        </div>
    </div>

    <script>
    function disconnectAccount(accountId) {
        if (!confirm('Disconnect this account?')) return;
        fetch('/galleryout/social/accounts/' + accountId, {method: 'DELETE'})
        .then(r => r.json()).then(data => {
            if (data.success) location.reload();
            else alert(data.error || 'Error disconnecting account');
        }).catch(err => alert('Error: ' + err));
    }

    function updateUserRole(userId, role) {
        fetch('/galleryout/social/users/' + userId, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({role: role})
        }).then(r => r.json()).then(data => {
            if (!data.success) alert(data.error || 'Error updating user');
        }).catch(err => alert('Error: ' + err));
    }

    function deleteUser(userId, username) {
        if (!confirm('Delete user "' + username + '"? This cannot be undone.')) return;
        fetch('/galleryout/social/users/' + userId, {method: 'DELETE'})
        .then(r => r.json()).then(data => {
            if (data.success) {
                document.getElementById('user-' + userId).remove();
            } else {
                alert(data.error || 'Error deleting user');
            }
        }).catch(err => alert('Error: ' + err));
    }

    function testSharePoint() {
        const btn = document.getElementById('sp-test-btn');
        const result = document.getElementById('sp-result');
        btn.disabled = true;
        btn.textContent = 'Testing...';
        result.style.display = 'block';
        result.className = 'sp-result info';
        result.textContent = 'Connecting to SharePoint...';
        fetch('/galleryout/social/sharepoint/test')
        .then(r => r.json()).then(data => {
            if (data.success) {
                let libs = (data.libraries || []).map(l => l.name).join(', ');
                result.className = 'sp-result success';
                result.textContent = 'Connection successful. Available libraries: ' + (libs || 'none found');
            } else {
                result.className = 'sp-result error';
                result.textContent = 'Failed' + (data.step ? ' at ' + data.step : '') + ': ' + (data.error || 'Unknown error');
            }
        }).catch(err => {
            result.className = 'sp-result error';
            result.textContent = 'Request failed: ' + err;
        }).finally(() => {
            btn.disabled = false;
            btn.textContent = 'Test Connection';
        });
    }

    function syncSharePoint() {
        const btn = document.getElementById('sp-sync-btn');
        const result = document.getElementById('sp-result');
        btn.disabled = true;
        btn.textContent = 'Syncing...';
        result.style.display = 'block';
        result.className = 'sp-result info';
        result.textContent = 'Syncing files from SharePoint...';
        fetch('/galleryout/social/sharepoint/sync', {method: 'POST'})
        .then(r => {
            if (!r.ok) {
                return r.text().then(text => {
                    throw new Error(`Server error (${r.status}): ${text.substring(0, 100)}`);
                });
            }
            return r.json();
        }).then(data => {
            if (data.error) {
                result.className = 'sp-result error';
                result.textContent = 'Sync error: ' + data.error;
            } else {
                result.className = 'sp-result success';
                let msg = 'Sync complete. ' + data.synced_count + ' file(s) synced.';
                if (data.folders) {
                    const folderResults = Object.entries(data.folders)
                        .map(([name, info]) => `${name}: ${info.synced}`)
                        .join(', ');
                    if (folderResults) msg += ' (' + folderResults + ')';
                }
                result.textContent = msg;
                loadSyncFolders(); // Refresh the folder list
            }
        }).catch(err => {
            result.className = 'sp-result error';
            result.textContent = 'Sync failed: ' + err.message;
        }).finally(() => {
            btn.disabled = false;
            btn.textContent = 'Sync Now';
        });
    }

    // SharePoint Sync Folder Management - Tree View with Multi-Select
    let spTreeData = {};        // Cached folder data by path
    let spExpandedPaths = {};   // Track which paths are expanded
    let spSelectedPaths = {};   // Track selected folder paths {path: {name, path}}
    let spAllFolders = [];      // Flat list of all loaded folders for search
    let spSearchQuery = '';     // Current search query

    function loadSyncFolders() {
        const list = document.getElementById('sp-folder-list');
        if (!list) return;

        fetch('/galleryout/social/sharepoint/sync-folders')
        .then(r => r.json()).then(data => {
            if (data.folders && data.folders.length > 0) {
                list.innerHTML = data.folders.map(f => {
                    const lastSync = f.last_sync_at
                        ? new Date(f.last_sync_at * 1000).toLocaleString()
                        : 'Never';
                    return `
                        <div class="sp-folder-item" id="sync-folder-${f.id}">
                            <div class="sp-folder-info">
                                <div class="sp-folder-local">
                                    <span class="sp-badge">SP</span>
                                    ${f.local_folder_name}
                                    ${f.include_subfolders ? '' : '<span style="font-size:0.7rem;color:var(--text-muted);">(no subs)</span>'}
                                </div>
                                <div class="sp-folder-remote">${f.sp_folder_path || '(root)'}</div>
                                <div class="sp-folder-meta">Last sync: ${lastSync} | Files: ${f.last_sync_count || 0}</div>
                            </div>
                            <div class="sp-folder-actions">
                                <button class="btn btn-danger btn-sm" onclick="removeSyncFolder('${f.id}')">Remove</button>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                list.innerHTML = '<p class="sp-no-folders">No folders configured. Add a folder from SharePoint to start syncing.</p>';
            }
        }).catch(err => {
            list.innerHTML = '<p class="sp-no-folders" style="color:var(--danger-color);">Error loading folders</p>';
        });
    }

    function openSpFolderBrowser() {
        document.getElementById('sp-folder-modal').classList.add('active');
        document.getElementById('sp-modal-footer').style.display = 'none';
        document.getElementById('sp-selection-count').style.display = 'none';
        document.getElementById('sp-search-input').value = '';
        spSelectedPaths = {};
        spSearchQuery = '';
        spTreeData = {};
        spExpandedPaths = {};
        spAllFolders = [];
        loadSpTreeRoot();
    }

    function closeSpFolderBrowser() {
        document.getElementById('sp-folder-modal').classList.remove('active');
    }

    // Load root folders using lazy loading endpoint
    async function loadSpTreeRoot() {
        const treeEl = document.getElementById('sp-tree');
        const loadingEl = document.getElementById('sp-tree-loading');
        const noResultsEl = document.getElementById('sp-no-results');

        loadingEl.style.display = 'block';
        treeEl.style.display = 'none';
        noResultsEl.style.display = 'none';

        try {
            const resp = await fetch('/galleryout/social/sharepoint/folder-children?path=');
            const data = await resp.json();

            if (data.error) {
                loadingEl.textContent = 'Error: ' + data.error;
                loadingEl.style.color = 'var(--danger-color)';
                return;
            }

            // Store root folders
            spTreeData[''] = data.folders || [];

            // Add to flat list for search
            spAllFolders = [...(data.folders || [])];

            loadingEl.style.display = 'none';
            treeEl.style.display = 'block';

            renderSpTree();
        } catch (err) {
            loadingEl.textContent = 'Error loading folders: ' + err;
            loadingEl.style.color = 'var(--danger-color)';
        }
    }

    // Load children for a specific folder path
    async function loadSpChildren(parentPath, expandBtn) {
        if (spTreeData[parentPath]) {
            // Already loaded, just toggle visibility
            return spTreeData[parentPath];
        }

        expandBtn.classList.add('loading');
        expandBtn.textContent = '‚ü≥';

        try {
            const resp = await fetch('/galleryout/social/sharepoint/folder-children?path=' + encodeURIComponent(parentPath));
            const data = await resp.json();

            if (data.error) {
                console.error('Error loading children:', data.error);
                expandBtn.classList.remove('loading');
                expandBtn.textContent = '‚ñ∂';
                return [];
            }

            spTreeData[parentPath] = data.folders || [];

            // Add to flat list for search
            spAllFolders = [...spAllFolders, ...(data.folders || [])];

            expandBtn.classList.remove('loading');
            return data.folders || [];
        } catch (err) {
            console.error('Error loading children:', err);
            expandBtn.classList.remove('loading');
            expandBtn.textContent = '‚ñ∂';
            return [];
        }
    }

    function renderSpTree() {
        const treeEl = document.getElementById('sp-tree');
        const noResultsEl = document.getElementById('sp-no-results');

        if (spSearchQuery) {
            // Search mode - show flat filtered list
            const query = spSearchQuery.toLowerCase();
            const filtered = spAllFolders.filter(f =>
                f.name.toLowerCase().includes(query) ||
                f.path.toLowerCase().includes(query)
            );

            if (filtered.length === 0) {
                treeEl.style.display = 'none';
                noResultsEl.style.display = 'block';
                return;
            }

            noResultsEl.style.display = 'none';
            treeEl.style.display = 'block';
            treeEl.innerHTML = filtered.map(f => renderSearchResultNode(f)).join('');
        } else {
            // Tree mode
            noResultsEl.style.display = 'none';
            treeEl.style.display = 'block';

            // Add root option at the top
            let html = renderTreeNode({
                name: 'üìö Document Library Root',
                path: '',
                has_children: (spTreeData[''] || []).length > 0,
                child_count: (spTreeData[''] || []).length,
                isRoot: true
            }, 0);

            // Render root-level folders
            const rootFolders = spTreeData[''] || [];
            html += rootFolders.map(f => renderTreeNode(f, 0)).join('');

            treeEl.innerHTML = html;
        }
    }

    function renderTreeNode(folder, depth) {
        const isSelected = spSelectedPaths[folder.path] !== undefined;
        const isExpanded = spExpandedPaths[folder.path];
        const hasChildren = folder.has_children || folder.child_count > 0;
        const expandIcon = folder.isRoot ? '' : (hasChildren ? (isExpanded ? '‚ñº' : '‚ñ∂') : '&nbsp;&nbsp;');

        let html = `
            <div class="sp-tree-node" data-path="${folder.path}">
                <div class="sp-tree-row ${isSelected ? 'highlighted' : ''}">
                    ${!folder.isRoot ? `<span class="sp-tree-expand" onclick="toggleSpExpand('${folder.path}', this)" ${!hasChildren ? 'style="visibility:hidden;"' : ''}>${expandIcon}</span>` : '<span style="width:20px;"></span>'}
                    <input type="checkbox" class="sp-tree-checkbox"
                           ${isSelected ? 'checked' : ''}
                           onchange="toggleSpSelection('${folder.path}', '${folder.name.replace(/'/g, "\\'")}', this)">
                    <span class="sp-tree-icon">${folder.isRoot ? '' : 'üìÅ'}</span>
                    <span class="sp-tree-name" onclick="toggleSpSelection('${folder.path}', '${folder.name.replace(/'/g, "\\'")}', this.parentElement.querySelector('.sp-tree-checkbox'))">${folder.name}</span>
                    ${!folder.isRoot && folder.child_count > 0 ? `<span class="sp-tree-count">${folder.child_count}</span>` : ''}
                </div>`;

        // Render children if expanded
        if (isExpanded && spTreeData[folder.path]) {
            html += `<div class="sp-tree-children" id="sp-children-${folder.path.replace(/[^a-zA-Z0-9]/g, '_')}">`;
            for (const child of spTreeData[folder.path]) {
                html += renderTreeNode(child, depth + 1);
            }
            html += '</div>';
        } else if (hasChildren && !folder.isRoot) {
            // Placeholder for children (collapsed)
            html += `<div class="sp-tree-children collapsed" id="sp-children-${folder.path.replace(/[^a-zA-Z0-9]/g, '_')}"></div>`;
        }

        html += '</div>';
        return html;
    }

    function renderSearchResultNode(folder) {
        const isSelected = spSelectedPaths[folder.path] !== undefined;
        return `
            <div class="sp-tree-node" data-path="${folder.path}">
                <div class="sp-tree-row ${isSelected ? 'highlighted' : ''}">
                    <span style="width:20px;"></span>
                    <input type="checkbox" class="sp-tree-checkbox"
                           ${isSelected ? 'checked' : ''}
                           onchange="toggleSpSelection('${folder.path}', '${folder.name.replace(/'/g, "\\'")}', this)">
                    <span class="sp-tree-icon">üìÅ</span>
                    <span class="sp-tree-name" onclick="toggleSpSelection('${folder.path}', '${folder.name.replace(/'/g, "\\'")}', this.parentElement.querySelector('.sp-tree-checkbox'))">${folder.path || folder.name}</span>
                </div>
            </div>`;
    }

    async function toggleSpExpand(path, expandBtn) {
        if (spExpandedPaths[path]) {
            // Collapse
            delete spExpandedPaths[path];
            expandBtn.textContent = '‚ñ∂';
            const childrenEl = document.getElementById('sp-children-' + path.replace(/[^a-zA-Z0-9]/g, '_'));
            if (childrenEl) childrenEl.classList.add('collapsed');
        } else {
            // Expand - load children if needed
            const children = await loadSpChildren(path, expandBtn);
            spExpandedPaths[path] = true;
            expandBtn.textContent = '‚ñº';

            // Re-render the tree to show children
            renderSpTree();
        }
    }

    function toggleSpSelection(path, name, checkbox) {
        if (checkbox.checked || !spSelectedPaths[path]) {
            spSelectedPaths[path] = { path, name };
            checkbox.checked = true;
        } else {
            delete spSelectedPaths[path];
            checkbox.checked = false;
        }

        // Update selection count and footer visibility
        const count = Object.keys(spSelectedPaths).length;
        const countEl = document.getElementById('sp-selection-count');
        const footerEl = document.getElementById('sp-modal-footer');
        const countNumEl = document.getElementById('sp-selected-count');

        countNumEl.textContent = count;
        countEl.style.display = count > 0 ? 'block' : 'none';
        footerEl.style.display = count > 0 ? 'block' : 'none';

        // Update button text
        document.getElementById('sp-add-btn').textContent =
            count === 1 ? 'Add Selected Folder' : `Add ${count} Selected Folders`;

        // Highlight the row
        const row = checkbox.closest('.sp-tree-row');
        if (row) {
            row.classList.toggle('highlighted', checkbox.checked);
        }
    }

    function filterSpFolders() {
        const input = document.getElementById('sp-search-input');
        spSearchQuery = input.value.trim();
        renderSpTree();
    }

    async function addSelectedSpFolders() {
        const selected = Object.values(spSelectedPaths);
        if (selected.length === 0) return;

        const includeSubfolders = document.getElementById('sp-include-subfolders').checked;
        const btn = document.getElementById('sp-add-btn');
        btn.disabled = true;
        btn.textContent = 'Adding...';

        let successCount = 0;
        let errorMessages = [];

        for (const folder of selected) {
            // Generate local name: SP-{foldername}
            const localName = folder.path
                ? 'SP-' + folder.path.split('/').pop()
                : 'SP-{{ sp_library }}';

            try {
                const resp = await fetch('/galleryout/social/sharepoint/sync-folders', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        sp_folder_path: folder.path,
                        sp_folder_name: folder.name,
                        local_folder_name: localName,
                        include_subfolders: includeSubfolders
                    })
                });
                const data = await resp.json();

                if (data.success) {
                    successCount++;
                } else {
                    errorMessages.push(`${folder.name}: ${data.error || 'Unknown error'}`);
                }
            } catch (err) {
                errorMessages.push(`${folder.name}: ${err}`);
            }
        }

        btn.disabled = false;
        btn.textContent = 'Add Selected Folders';

        // Show result
        const result = document.getElementById('sp-result');
        result.style.display = 'block';

        if (successCount > 0) {
            closeSpFolderBrowser();
            loadSyncFolders();
            result.className = 'sp-result success';
            result.textContent = `${successCount} folder(s) added. Click "Sync Now" to download files.`;
            if (errorMessages.length > 0) {
                result.textContent += ` (${errorMessages.length} failed)`;
            }
        } else {
            result.className = 'sp-result error';
            result.textContent = 'Failed to add folders: ' + errorMessages.join('; ');
        }
    }

    function removeSyncFolder(folderId) {
        if (!confirm('Remove this sync folder configuration? (Files already downloaded will remain in the gallery)')) return;

        fetch('/galleryout/social/sharepoint/sync-folders/' + folderId, {method: 'DELETE'})
        .then(r => r.json()).then(data => {
            if (data.success) {
                document.getElementById('sync-folder-' + folderId).remove();
                // Check if list is now empty
                const list = document.getElementById('sp-folder-list');
                if (!list.querySelector('.sp-folder-item')) {
                    list.innerHTML = '<p class="sp-no-folders">No folders configured. Add a folder from SharePoint to start syncing.</p>';
                }
            } else {
                alert(data.error || 'Error removing folder');
            }
        }).catch(err => {
            alert('Error: ' + err);
        });
    }

    // Load sync folders on page load
    document.addEventListener('DOMContentLoaded', () => {
        if (document.getElementById('sp-folder-list')) {
            loadSyncFolders();
        }
    });

    // Close modal on Escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeSpFolderBrowser();
    });

    // Close modal on overlay click
    document.getElementById('sp-folder-modal')?.addEventListener('click', (e) => {
        if (e.target.id === 'sp-folder-modal') closeSpFolderBrowser();
    });

    // Email test functionality
    function sendTestEmail() {
        const emailInput = document.getElementById('test-email-address');
        const btn = document.getElementById('email-test-btn');
        const result = document.getElementById('email-result');
        const toEmail = emailInput.value.trim();

        if (!toEmail) {
            result.style.display = 'block';
            result.className = 'sp-result error';
            result.textContent = 'Please enter an email address';
            return;
        }

        btn.disabled = true;
        btn.textContent = 'Sending...';
        result.style.display = 'block';
        result.className = 'sp-result info';
        result.textContent = 'Sending test email...';

        fetch('/galleryout/social/email/test', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({to_email: toEmail})
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                result.className = 'sp-result success';
                result.textContent = data.message || 'Test email sent successfully!';
            } else {
                result.className = 'sp-result error';
                result.textContent = data.error || 'Failed to send test email';
            }
        })
        .catch(err => {
            result.className = 'sp-result error';
            result.textContent = 'Error: ' + err;
        })
        .finally(() => {
            btn.disabled = false;
            btn.textContent = 'Send Test Email';
        });
    }

    function addUser(e) {
        e.preventDefault();
        const data = {
            username: document.getElementById('new-username').value,
            display_name: document.getElementById('new-display-name').value,
            password: document.getElementById('new-password').value,
            role: document.getElementById('new-role').value,
        };
        fetch('/galleryout/social/users', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        }).then(r => r.json()).then(result => {
            if (result.success) location.reload();
            else if (result.errors) alert(result.errors.join('\n'));
            else alert('Error creating user');
        }).catch(err => alert('Error: ' + err));
        return false;
    }

    // =========== Storage Management Functions ===========
    function refreshStorageStatus() {
        const healthDiv = document.getElementById('storage-health');
        const healthStatus = document.getElementById('health-status');
        const healthPercent = document.getElementById('health-percent');
        const healthBar = document.getElementById('health-bar');
        const healthDetails = document.getElementById('health-details');
        const healthRecs = document.getElementById('health-recommendations');
        const cacheBreakdown = document.getElementById('cache-breakdown');
        const retentionInfo = document.getElementById('retention-values');

        healthStatus.textContent = 'Loading storage status...';

        fetch('/galleryout/social/maintenance/status')
        .then(r => r.json())
        .then(data => {
            if (!data.success) {
                healthStatus.textContent = 'Error: ' + (data.error || 'Unknown error');
                healthStatus.style.color = 'var(--danger-color)';
                // Show traceback for debugging if available
                if (data.traceback) {
                    cacheBreakdown.innerHTML = '<pre style="font-size:0.75rem;color:var(--text-muted);overflow:auto;max-height:200px;background:var(--bg-color);padding:0.5rem;border-radius:4px;">' +
                        data.traceback.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</pre>';
                }
                return;
            }

            const usage = data.usage;
            const health = usage.health;
            const volume = usage.volume;

            // Update timestamp
            const now = new Date();
            const timestamp = now.toLocaleDateString('en-US', {
                weekday: 'short', year: 'numeric', month: 'short', day: 'numeric'
            }) + ' ' + now.toLocaleTimeString('en-US', {
                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true
            });
            document.getElementById('storage-timestamp').textContent = 'Last updated: ' + timestamp;

            // Update health display
            healthPercent.textContent = health.percent_used.toFixed(1) + '%';
            healthBar.style.width = health.percent_used + '%';

            // Color based on status
            let barColor = 'var(--success-color)';
            let statusColor = 'var(--success-color)';
            if (health.status === 'warning') {
                barColor = 'var(--favorite-color)';
                statusColor = 'var(--favorite-color)';
            } else if (health.status === 'critical') {
                barColor = '#fd7e14';
                statusColor = '#fd7e14';
            } else if (health.status === 'emergency') {
                barColor = 'var(--danger-color)';
                statusColor = 'var(--danger-color)';
            }
            healthBar.style.background = barColor;
            healthStatus.style.color = statusColor;
            healthStatus.textContent = health.message;

            // Volume details
            healthDetails.innerHTML = `
                <span>Total: <strong>${volume.total_gb.toFixed(1)} GB</strong></span> |
                <span>Used: <strong>${volume.used_gb.toFixed(1)} GB</strong></span> |
                <span>Free: <strong>${volume.free_gb.toFixed(1)} GB</strong></span>
            `;

            // Recommendations
            if (health.recommendations && health.recommendations.length > 0) {
                healthRecs.style.display = 'block';
                healthRecs.style.color = statusColor;
                healthRecs.innerHTML = '<strong>Recommendations:</strong><ul style="margin:0.3rem 0 0 1.5rem;">' +
                    health.recommendations.map(r => '<li>' + r + '</li>').join('') + '</ul>';
            } else {
                healthRecs.style.display = 'none';
            }

            // Helper function to format size
            const formatSize = (bytes) => {
                if (bytes >= 1024 * 1024 * 1024) return (bytes / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
                if (bytes >= 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
                return (bytes / 1024).toFixed(1) + ' KB';
            };

            let breakdownHtml = '';

            // === DISK USAGE OVERVIEW ===
            breakdownHtml += '<div style="margin-bottom:1rem;"><strong style="color:var(--text-color);">Disk Usage Overview</strong></div>';
            breakdownHtml += '<div style="display:grid;gap:0.5rem;margin-bottom:1.5rem;">';

            const overviewItems = [
                { key: 'media_total', label: 'Media Files', icon: 'üìÅ', color: '#667eea' },
                { key: 'cache_total', label: 'Cache & Temp', icon: 'üóÇÔ∏è', color: '#f5576c' },
                { key: 'other_system', label: 'System & Other', icon: 'üíª', color: '#6c757d' },
            ];

            const volumeUsed = volume.used_bytes || 0;
            for (const item of overviewItems) {
                const data = usage[item.key];
                if (!data) continue;
                const sizeBytes = data.size_bytes || 0;
                const percent = volumeUsed > 0 ? (sizeBytes / volumeUsed * 100).toFixed(1) : 0;
                const fileCount = data.file_count;

                breakdownHtml += `
                    <div style="padding:0.6rem;background:var(--bg-color);border-radius:4px;border-left:3px solid ${item.color};">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <span>${item.icon} ${item.label}</span>
                            <span style="font-family:monospace;font-weight:600;">${formatSize(sizeBytes)}</span>
                        </div>
                        <div style="font-size:0.8rem;color:var(--text-muted);margin-top:0.25rem;">
                            ${percent}% of used space${fileCount !== undefined ? ` ‚Ä¢ ${fileCount.toLocaleString()} files` : ''}
                        </div>
                    </div>
                `;
            }
            breakdownHtml += '</div>';

            // === MEDIA BREAKDOWN ===
            breakdownHtml += '<div style="margin-bottom:0.5rem;"><strong style="color:var(--text-color);">Media Files Breakdown</strong></div>';
            breakdownHtml += '<div style="display:grid;gap:0.3rem;margin-bottom:1.5rem;">';

            const mediaItems = [
                { key: 'media_images', label: 'Images', icon: 'üñºÔ∏è' },
                { key: 'media_videos', label: 'Videos', icon: 'üé•' },
                { key: 'media_audio', label: 'Audio', icon: 'üéµ' },
                { key: 'media_other', label: 'Other Files', icon: 'üìÑ' },
            ];

            for (const item of mediaItems) {
                const data = usage[item.key];
                if (!data || data.file_count === 0) continue;
                const topExts = data.top_extensions ? data.top_extensions.slice(0, 3).map(e => e[0]).join(', ') : '';

                breakdownHtml += `
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:0.4rem 0.6rem;background:var(--glass-bg);border-radius:4px;">
                        <span style="font-size:0.9rem;">${item.icon} ${item.label}</span>
                        <span style="font-family:monospace;font-size:0.9rem;">
                            <strong>${formatSize(data.size_bytes)}</strong>
                            <span style="color:var(--text-muted);font-size:0.75rem;margin-left:0.5rem;">(${data.file_count.toLocaleString()} files${topExts ? ' ‚Ä¢ ' + topExts : ''})</span>
                        </span>
                    </div>
                `;
            }
            breakdownHtml += '</div>';

            // === CACHE BREAKDOWN ===
            breakdownHtml += '<div style="margin-bottom:0.5rem;"><strong style="color:var(--text-color);">Cache & Temp Breakdown</strong></div>';
            breakdownHtml += '<div style="display:grid;gap:0.3rem;">';

            const cacheItems = [
                { key: 'thumbnails', label: 'Thumbnails', icon: 'üñºÔ∏è' },
                { key: 'zip', label: 'ZIP Downloads', icon: 'üì¶' },
                { key: 'smashcut', label: 'Smashcut Output', icon: 'üé¨' },
                { key: 'sharepoint', label: 'SharePoint Cache', icon: '‚òÅÔ∏è' },
                { key: 'database', label: 'Database', icon: 'üóÑÔ∏è' },
            ];

            for (const item of cacheItems) {
                const cache = usage[item.key];
                if (!cache) continue;
                const fileCount = cache.file_count || 0;
                const ageInfo = cache.oldest_file_age_hours ?
                    `oldest: ${cache.oldest_file_age_hours.toFixed(0)}h` : '';

                breakdownHtml += `
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:0.4rem 0.6rem;background:var(--glass-bg);border-radius:4px;">
                        <span style="font-size:0.9rem;">${item.icon} ${item.label}</span>
                        <span style="font-family:monospace;font-size:0.9rem;">
                            <strong>${formatSize(cache.size_bytes)}</strong>
                            <span style="color:var(--text-muted);font-size:0.75rem;margin-left:0.5rem;">(${fileCount} files${ageInfo ? ', ' + ageInfo : ''})</span>
                        </span>
                    </div>
                `;
            }
            breakdownHtml += '</div>';

            cacheBreakdown.innerHTML = breakdownHtml;

            // Retention settings
            const config = usage.config;
            retentionInfo.innerHTML = `ZIP: ${config.zip_retention_hours}h | Smashcut: ${config.smashcut_retention_hours}h | ` +
                `Thresholds: Warning ${config.warning_threshold}%, Critical ${config.critical_threshold}%, Emergency ${config.emergency_threshold}%`;
        })
        .catch(err => {
            healthStatus.textContent = 'Error loading storage status: ' + err;
            healthStatus.style.color = 'var(--danger-color)';
        });
    }

    function runMaintenance(aggressive) {
        const resultDiv = document.getElementById('maintenance-result');
        const confirmMsg = aggressive ?
            'Run EMERGENCY cleanup? This will use aggressive retention (1h for ZIPs, 24h for smashcut).' :
            'Run standard maintenance cleanup?';

        if (!confirm(confirmMsg)) return;

        resultDiv.style.display = 'block';
        resultDiv.className = '';
        resultDiv.style.background = 'var(--glass-bg)';
        resultDiv.style.border = '1px solid var(--glass-border)';
        resultDiv.innerHTML = '<span style="color:var(--text-muted);">Running maintenance...</span>';

        const url = '/galleryout/social/maintenance/run' + (aggressive ? '?aggressive=true' : '');
        fetch(url, { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (!data.success) {
                resultDiv.style.background = 'rgba(220, 53, 69, 0.1)';
                resultDiv.style.border = '1px solid var(--danger-color)';
                resultDiv.innerHTML = '<strong style="color:var(--danger-color);">Error:</strong> ' + (data.error || 'Unknown error');
                return;
            }

            const results = data.results;
            const summary = results.summary;
            const freedMb = summary.total_freed_mb.toFixed(1);
            const freedDisplay = freedMb >= 1024 ? (freedMb/1024).toFixed(2) + ' GB' : freedMb + ' MB';

            resultDiv.style.background = 'rgba(32, 201, 151, 0.1)';
            resultDiv.style.border = '1px solid var(--success-color)';
            resultDiv.innerHTML = `
                <strong style="color:var(--success-color);">Maintenance Complete</strong><br>
                <span style="font-size:1.2rem;font-weight:600;">${freedDisplay} freed</span> |
                <span>${summary.total_deleted_files} files deleted</span> |
                <span>${summary.duration_seconds.toFixed(1)}s</span>
                <div style="margin-top:0.5rem;font-size:0.85rem;color:var(--text-muted);">
                    ZIP: ${results.zip.deleted_count} files (${(results.zip.freed_bytes/1024/1024).toFixed(1)}MB) |
                    Smashcut: ${results.smashcut.deleted_count} files (${(results.smashcut.freed_bytes/1024/1024).toFixed(1)}MB) |
                    Thumbnails: ${results.thumbnails.deleted_count} files |
                    DB: ${(results.database.freed_bytes/1024/1024).toFixed(1)}MB reclaimed
                </div>
            `;

            // Refresh status after maintenance
            setTimeout(refreshStorageStatus, 500);
        })
        .catch(err => {
            resultDiv.style.background = 'rgba(220, 53, 69, 0.1)';
            resultDiv.style.border = '1px solid var(--danger-color)';
            resultDiv.innerHTML = '<strong style="color:var(--danger-color);">Error:</strong> ' + err;
        });
    }

    // Load storage status on page load
    document.addEventListener('DOMContentLoaded', () => {
        if (document.getElementById('storage-section')) {
            refreshStorageStatus();
        }
    });
    </script>
</body>
</html>
